---
title: "Lab temperature data clean up"
output:
  html_document:
    toc: true
    toc_float: true
    theme: paper
---

```{r load_libraries, echo=FALSE, message=FALSE}
  if (!require("pacman")) install.packages("pacman")
  pacman::p_load(tidyverse, patchwork, weathermetrics, lme4, MuMIn, hms)
  options(knitr.table.format = "latex")
```

```{r global_options, include=FALSE}
  knitr::opts_chunk$set(fig.path = 'figures/', warning = FALSE,
                        message = FALSE, cache = FALSE)
```

```{r}
  source("../r_scripts/functions.R")
```

```{r, echo=FALSE}
  times <- readRDS("../r_files/lab_segments.RDS")
  samples <- readRDS("../r_files/lab_samples.RDS")
  firepower <- readRDS("../r_files/lab_firepower.RDS")
  flue_temp <- readRDS("../r_files/lab_flue_temp.RDS")
```

# Select only stoves of interest

```{r}
  flue_temp <-
    flue_temp %>%
    na.omit %>%
    dplyr::left_join(dplyr::select(samples, id, stove, fuel), by = "id") %>%
    dplyr::filter(grepl("chulha|Rocket|Ceramic plancha", stove))
```

```{r}
  firepower <-
    firepower %>%
    na.omit %>%
    dplyr::left_join(dplyr::select(samples, id, stove, fuel), by = "id") %>%
    dplyr::filter(grepl("chulha|Rocket|Ceramic plancha", stove))
```

# Convert "hood a" data to Celsius

```{r}
  flue_temp <-
    flue_temp %>%
    dplyr::mutate(hood = ifelse(grepl("^19B$|^17B$|^14B$|^11B$|^29B$|^22B$|^15B$|^13B$|^1B$|^9B$|^4B$|^12B$|^8B$|^2B$|^18B$|^20B$|^10B$|^7B$|^16B$|^21B$|^3B$|^9C$|^18C$|^13C$|^21C$|^7C$|^19C$|^1C$|^20C$|^2C$|^15C$|^11C$|^15D$|^19D$|^13D", id), "b", "a"))
```

```{r}
  flue_temp <-
    flue_temp %>%
    dplyr::mutate(temp = ifelse(hood == "a", kelvin.to.celsius(temp), temp))
```

# Fix missing second data of hood b

* Come back and improve this later (improvement probably won't change result)

```{r}
  hood_b <-
    flue_temp %>%
    dplyr::filter(hood == "b") %>%
    #dplyr::mutate(minutes = hms(time)) %>%
    dplyr::group_by(id, stove, fuel, date, time) %>%
    dplyr::mutate(rnum = row_number(),
                  rnum = (rnum - 1) * 2,
                  rnum = as.character(rnum)) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(rnum = str_pad(rnum, 2, pad = "0"),
                  time = gsub(":00", "", time),
                  time = paste0(time, ":", rnum),
                  time = as.hms(time)) %>%
    dplyr::select(-hood, -rnum)
```

```{r}
  flue_temp <-
    flue_temp %>%
    dplyr::filter(hood != "b") %>%
    dplyr::select(-hood) %>%
    dplyr::bind_rows(hood_b)
```

# Subtract ambient temperature

```{r}
  amb_temp <- tibble::data_frame(id = c("10B", "10C", "11A", "11C", "12A", "12B",
                                        "12C", "13A", "13B", "13C", "14A", "14C",
                                        "15C", "16A", "16C", "19A", "20A", "20B",
                                        "20C", "21A", "21C", "6A", "8A", "8B",
                                        "8C", "9A", "9B", "9C"),
                                 amb_temp = c(21.6, 29.8, 27.56, 25.6, 29.0, 23.5,
                                              26.15, 28.26, 24.2, 22.7, 29.0, 29.0,
                                              20.3, 33.03, 32.48, 29.0, 31.35, 24.1,
                                              24.7, 28.33, 24.7, 33.88, 28.07, 24.8,
                                              26.15, 28.9, 23.1, 24.9))
```

```{r, eval = FALSE}
  flue_temp <-
    flue_temp %>%
    dplyr::left_join(amb_temp, by = "id") %>%
    dplyr::mutate(temp = temp - amb_temp) %>%
    dplyr::select(-amb_temp)
```

# Remove start-up and shut-down data

```{r}
  times <-
    times %>%
    dplyr::filter(grepl("start_2|end_8", var)) %>%
    tidyr::spread("var", "val") %>%
    dplyr::rename("start" = "start_2",
                  "end" = "end_8",
                  "id" = "test_id") %>%
    na.omit
```

```{r}
  flue_temp <-
    flue_temp %>%
    dplyr::mutate(date = as.Date(date, "%m/%d/%y"))
```

```{r}
  firepower <-
    firepower %>%
    dplyr::mutate(date = as.Date(date, "%m/%d/%y"))
```

```{r}
  flue_temp <- filter_times4(times, flue_temp)
  firepower <- filter_times4(times, firepower)
```

# One minute averages

```{r}
  flue_temp <- 
    flue_temp %>%
    dplyr::mutate(datetime = as.POSIXct(paste0(date, time))) %>%
    dplyr::select(id, stove, fuel, datetime, temp) %>%
    dplyr::group_by(id, stove, fuel, datetime = cut(datetime, breaks = "1 min")) %>%
    dplyr::summarise(temp = mean(temp))
```

```{r}
  firepower <- 
    firepower  %>%
    dplyr::mutate(datetime = as.POSIXct(paste0(date, time))) %>%
    dplyr::select(id, stove, fuel, datetime, firepower) %>%
    dplyr::group_by(id, stove, fuel, datetime = cut(datetime, breaks = "1 min")) %>%
    dplyr::summarise(firepower = mean(firepower))
```

```{r}
  firepower_max <-
    firepower %>%
    dplyr::group_by(stove) %>%
    dplyr::summarise(max_fp = max(firepower))

  saveRDS(firepower_max, "../r_files/firepower_max.RDS")
```

# Combine with firepower data

```{r}
  temp_fp <-
    flue_temp %>%
    dplyr::left_join(firepower, by = c("id", "stove", "fuel", "datetime")) %>%
    dplyr::mutate(datetime = as.POSIXct(paste0(datetime)))
```

# Try different averaging times

```{r}
  temp_fp <- 
    temp_fp %>%
    dplyr::group_by(id, stove, fuel, datetime = cut(datetime, breaks = "3 min")) %>%
    dplyr::summarise(temp = mean(temp, na.rm = TRUE),
                     firepower = mean(firepower, na.rm = TRUE)) %>%
    dplyr::mutate(datetime = as.POSIXct(paste0(datetime)))
```

# Quality control

## Extract tests that are missing substantial data

```{r}
  temp_fp <-
    temp_fp %>%
    dplyr::filter(id != "19C", id != "15A", id != "4C", id != "5A", id != "5C", id != "4B", id != "11A", id != "11C")
```

## Plot finalized data

```{r, fig.height=6, echo=FALSE}
  temp_fp %>%
    dplyr::mutate(temp = scale(temp),
                     firepower = scale(firepower)) %>%
      ggplot(aes(x = datetime, y = temp)) +
        geom_line() +
        geom_line(aes(x = datetime, y = firepower), color = "blue") +
        facet_wrap(.~id, scales = "free")
```

```{r, fig.height=6, echo=FALSE}
  ggplot(data = temp_fp, aes(x = temp, y = firepower)) +
    geom_point(aes(color = firepower)) +
    facet_wrap(.~id, scales = "free")
```

# Save data

```{r}
  saveRDS(temp_fp, "../r_files/lab_flue_temp_merged.RDS")
```