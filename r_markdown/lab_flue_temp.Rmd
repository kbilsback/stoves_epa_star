---
title: "Lab temperature data clean up"
output:
  html_document:
    toc: true
    toc_float: true
    theme: paper
---

```{r load_libraries, echo=FALSE, message=FALSE}
  if (!require("pacman")) install.packages("pacman")
  pacman::p_load(tidyverse, patchwork, weathermetrics, lme4, MuMIn, hms)
  options(knitr.table.format = "latex")
```

```{r global_options, include=FALSE}
  knitr::opts_chunk$set(fig.path = 'figures/', warning = FALSE,
                        message = FALSE, cache = FALSE)
```

```{r}
  source("../r_scripts/functions.R")
```

```{r, echo=FALSE}
  times <- readRDS("../r_files/lab_segments.RDS")
  samples <- readRDS("../r_files/lab_samples_v2.RDS")
  firepower <- readRDS("../r_files/lab_firepower.RDS")
  flue_temp <- readRDS("../r_files/lab_flue_temp.RDS")
```

# Select only stoves of interest

```{r}
  flue_temp <-
    flue_temp %>%
    na.omit %>%
    dplyr::left_join(dplyr::select(samples, id, stove, fuel, fst_type), by = "id")
```

```{r}
  firepower <-
    firepower %>%
    na.omit %>%
    dplyr::left_join(dplyr::select(samples, id, stove, fuel, fst_type), by = "id")
```

# Convert "hood a" data to Celsius

```{r}
  flue_temp <-
    flue_temp %>%
    dplyr::mutate(hood = ifelse(grepl("^19B$|^17B$|^14B$|^11B$|^29B$|^22B$|^15B$|^13B$|^1B$|^9B$|^4B$|^12B$|^8B$|^2B$|^18B$|^20B$|^10B$|^7B$|^16B$|^21B$|^3B$|^9C$|^18C$|^13C$|^21C$|^7C$|^19C$|^1C$|^20C$|^2C$|^15C$|^11C$|^15D$|^19D$|^13D", id), "b", "a"))
```

```{r}
  flue_temp <-
    flue_temp %>%
    dplyr::mutate(temp = ifelse(hood == "a", kelvin.to.celsius(temp), temp))
```

# Fix missing second data of hood b

* Come back and improve this later (improvement probably won't change result)

```{r}
  hood_b <-
    flue_temp %>%
    dplyr::filter(hood == "b") %>%
    #dplyr::mutate(minutes = hms(time)) %>%
    dplyr::group_by(id, stove, fuel, date, time) %>%
    dplyr::mutate(rnum = row_number(),
                  rnum = (rnum - 1) * 2,
                  rnum = as.character(rnum)) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(rnum = str_pad(rnum, 2, pad = "0"),
                  time = gsub(":00", "", time),
                  time = paste0(time, ":", rnum),
                  time = as.hms(time)) %>%
    dplyr::select(-hood, -rnum)
```

```{r}
  flue_temp <-
    flue_temp %>%
    dplyr::filter(hood != "b") %>%
    dplyr::select(-hood) %>%
    dplyr::bind_rows(hood_b)
```

# Subtract ambient temperature

```{r}
  amb_temp <- tibble::data_frame(id = c("10B", "10C", "11A", "11C", "12A", "12B",
                                        "12C", "13A", "13B", "13C", "14A", "14C",
                                        "15C", "16A", "16C", "19A", "20A", "20B",
                                        "20C", "21A", "21C", "6A", "8A", "8B",
                                        "8C", "9A", "9B", "9C",
                                        "17A", "17C", "18A", "18B",
                                        "1A", "1B", "1C",
                                        "20A", "20B", "20C",
                                        "21A", "21C", "22A", "24A",
                                        "2B", "2C", "3A", "3C",
                                        "4B", "6A", "7A", "9A", "9B", "9C"),
                                 amb_temp = c(21.6, 29.8, 27.56, 25.6, 29.0, 23.5,
                                              26.15, 28.26, 24.2, 22.7, 29.0, 29.0,
                                              20.3, 33.03, 32.48, 29.0, 31.35, 24.1,
                                              24.7, 28.33, 24.7, 33.88, 28.07, 24.8,
                                              26.15, 28.9, 23.1, 24.9,
                                              27.4, 33.7, 32.54, 22.7,
                                              31.54, 21.8, 23.9,
                                              31.35, 24.1, 24.7,
                                              28.33, 24.7, 27.2, 33.48,
                                              24.8, 25.6, 29.56, 26.15,
                                              23.3, 33.88, 31.98, 28.9, 23.1, 24.9))
```

* subtract ambient temperature
* exclude data that are less than twice the ambient temperature 

```{r}
  flue_temp <-
    flue_temp %>%
    dplyr::left_join(amb_temp, by = "id") %>%
    dplyr::mutate(frac_ambient = temp / amb_temp) %>%
    dplyr::filter(frac_ambient > 2) %>%
    dplyr::select(-frac_ambient) %>%
    dplyr::mutate(temp = temp - amb_temp) %>%
    dplyr::select(-amb_temp)
```

# Remove start-up and shut-down data

```{r}
  times_wood <-
    times %>%
    dplyr::filter(grepl("start_2|end_8", var)) %>%
    tidyr::spread("var", "val") %>%
    dplyr::rename("start" = "start_2",
                  "end" = "end_8",
                  "id" = "test_id") %>%
    na.omit

  times_charcoal <-
    times %>%
    dplyr::filter(grepl("9|10|11|12|13|14", test_id)) %>%
    dplyr::filter(grepl("start_2|end_6", var)) %>%
    tidyr::spread("var", "val") %>%
    dplyr::rename("start" = "start_2",
                  "end" = "end_6",
                  "id" = "test_id")

  times_gasifier <-
    times %>%
    dplyr::filter(grepl("22|23|24", test_id)) %>%
    dplyr::filter(grepl("start_2|end_6", var)) %>%
    tidyr::spread("var", "val") %>%
    dplyr::rename("start" = "start_2",
                  "end" = "end_6",
                  "id" = "test_id")
```

```{r}
  times_all <-
    times_wood %>%
    dplyr::bind_rows(times_charcoal) %>%
    dplyr::bind_rows(times_gasifier)
```

```{r}
  flue_temp <-
    flue_temp %>%
    dplyr::mutate(date = as.Date(date, "%m/%d/%y"))
```

```{r}
  firepower <-
    firepower %>%
    dplyr::mutate(date = as.Date(date, "%m/%d/%y"))
```

```{r}
  flue_temp <- filter_times4(times_all, flue_temp)
  firepower <- filter_times4(times_all, firepower)
```

# One minute averages

```{r}
  flue_temp <- 
    flue_temp %>%
    dplyr::mutate(datetime = as.POSIXct(paste0(date, time))) %>%
    dplyr::select(id, stove, fuel, datetime, temp, fst_type) %>%
    dplyr::group_by(id, stove, fuel, fst_type, datetime = cut(datetime, breaks = "1 min")) %>%
    dplyr::summarise(temp = mean(temp))
```

```{r}
  firepower <- 
    firepower  %>%
    dplyr::mutate(datetime = as.POSIXct(paste0(date, time))) %>%
    dplyr::select(id, stove, fuel, datetime, firepower, fst_type) %>%
    dplyr::group_by(id, stove, fuel, fst_type, datetime = cut(datetime, breaks = "1 min")) %>%
    dplyr::summarise(firepower = mean(firepower))
```

```{r}
  firepower_max <-
    firepower %>%
    dplyr::group_by(stove) %>%
    dplyr::summarise(max_fp = max(firepower))

  saveRDS(firepower_max, "../r_files/firepower_max.RDS")
```

# Combine with firepower data

```{r}
  temp_fp <-
    flue_temp %>%
    dplyr::left_join(firepower, by = c("id", "stove", "fuel", "datetime", "fst_type")) %>%
    dplyr::mutate(datetime = as.POSIXct(paste0(datetime)))
```

# Try different averaging times

```{r}
  temp_fp <- 
    temp_fp %>%
    dplyr::group_by(id, stove, fuel, fst_type, datetime = cut(datetime, breaks = "3 min")) %>%
    dplyr::summarise(temp = mean(temp, na.rm = TRUE),
                     firepower = mean(firepower, na.rm = TRUE)) %>%
    dplyr::mutate(datetime = as.POSIXct(paste0(datetime)))
```

# Quality control

## Extract tests that are missing substantial data

```{r}
  temp_fp <-
    temp_fp %>%
    dplyr::filter(id != "10A",
                  id != "11B",
                  id != "12A",
                  id != "14B",
                  id != "15A",
                  id != "15B",
                  id != "16B",
                  id != "16D",
                  id != "18C",
                  id != "19C",
                  id != "21B",
                  id != "22B",
                  id != "22C",
                  id != "23A",
                  id != "29B",
                  id != "4A",
                  id != "3B",
                  id != "4C",
                  id != "5A",
                  id != "5C",
                  id != "7B",
                  id != "7C")
```

## Plot finalized data

```{r, fig.height=6, echo=FALSE}
  temp_fp %>%
    dplyr::mutate(temp = scale(temp),
                     firepower = scale(firepower)) %>%
      ggplot(aes(x = datetime, y = temp)) +
        geom_line() +
        geom_line(aes(x = datetime, y = firepower), color = "blue") +
        facet_wrap(.~id, scales = "free")
```

## Remove okote data

```{r}
  temp_fp <-
    temp_fp %>%
    dplyr::filter(fuel != "okote")
```

# Save data

```{r}
  saveRDS(temp_fp, "../r_files/lab_temp_fp_merged.RDS")
```