---
title: "Part 2: Predict firepower using temperarure versus firepower models"
output:
  html_document:
    toc: true
    toc_float: true
    theme: paper
---

```{r load_libraries, echo=FALSE, message=FALSE}
  if (!require("pacman")) install.packages("pacman")
  pacman::p_load(tidyverse, knitr, patchwork, kableExtra, Matrix, mvtnorm, matrixcalc)
  options(knitr.table.format = "latex")
```

```{r, echo=FALSE, message=FALSE}
  library(tidyverse)
  library(mvtnorm)
```

```{r global_options, include=FALSE}
  knitr::opts_chunk$set(fig.path = 'figures/', warning = FALSE,
                        message = FALSE, cache = FALSE)
```

```{r, echo=FALSE}
  mod <- readRDS("../r_files/temp_fp_mod2.RDS")
  field_temp <- readRDS("../r_files/india_temp_merged.RDS")
  samples <- readRDS("../r_files/field_samples.RDS")
  fp <- readRDS("../r_files/field_firepower.RDS")
```

```{r, echo=FALSE}
  field_temp <-
    field_temp %>%
    dplyr::filter(hh_id != "IN10") %>%
    dplyr::mutate(temp = temp - 30) %>%
    dplyr::filter(temp > 0) %>%
    dplyr::left_join(dplyr::select(samples, hh_id, stove_type), by = "hh_id") %>%
    dplyr::filter(stove_type != "Traditional ceramic") %>%
    dplyr::rename(stove = stove_type) %>%
    dplyr::mutate(stove = as.factor(stove),
                  stove = fct_recode(stove,
                                     "Mud chulha" = "Mud chula"),
                  stove = fct_expand(stove,
                                     "Mud chulha",
                                     "Rocket elbow",
                                     "Ceramic plancha"))
```

# Summary of model being used

```{r}
  summary(mod)
```

# Summary of temperature data from the field

```{r, echo=FALSE, fig.height=4, eval=FALSE}
  ggplot(field_temp, aes(x = datetime, y = temp)) +
    geom_line() +
    theme_minimal() +
    facet_wrap(.~hh_id, scales = "free") +
    xlab("time") +
    ylab("temperature")
```

```{r, echo=FALSE, fig.height=2, eval=FALSE}
  field_temp %>%
    ggplot(aes(x = hh_id, y = temp)) +
    geom_boxplot() +
    theme_minimal() +
    xlab("") +
    ylab("temperature (celsius)")
```

# Estimate firepower based on model

```{r, echo=FALSE}
  field_temp_p <-
    field_temp %>%
    dplyr::select(stove, temp)
```

```{r}
  yhat <- predict(mod, field_temp_p, interval = "predict")
```

How would this work for a mixed-effect model?

# Bootstrap firepower estimates

Extract model estimates

```{r}
  yhat <- matrix(yhat[,1], ncol = 1)
```

Get covariance matrix for coefficients

```{r}
  varbetahat <- vcov(mod)
  is.positive.definite(varbetahat)
```

Get design matrix

```{r}
  Xmat <- model.matrix(~poly(temp,2)*stove, data = field_temp_p)
```

Calculate covariance matrix for fitted values

```{r}
  # round so it's symmetric, computer precision problem
  var.yhat <- round(Xmat %*% varbetahat %*% t(Xmat), 10)

  #is.positive.definite(var.yhat) # this is ok
  is.symmetric.matrix(var.yhat) # good
```

Randomly sample data from multivariate normal distribution

* gives B (b by n) vectors of estimate firepower
* each element of the vector is the estimate firepower for a certain temperature

```{r}
  B <- 10000  # number of samples

  fp.boot <- rmvnorm(B, yhat, var.yhat)
  dim(fp.boot)
```

```{r, echo=FALSE}
  saveRDS(fp.boot, "../r_files/fp_bootstrap.RDS")
```

# Plot predicted data

Reorganize data

```{r}
  fp_data <- t(fp.boot)

  fp_data <-  as.data.frame(fp_data)

  fp_data <-
    fp_data %>%
    dplyr::bind_cols(dplyr::select(field_temp, hh_id, stove, datetime)) %>%
    tidyr::gather("datetime", "val", 1:10000)
  
  fp_data <- fp_data[,-4]
```

Use standard deviation of the random samples as confidence intervals????

* I don't know if this is correct

```{r}
  fp_conf <-
    fp_data %>%
    dplyr::group_by(hh_id, stove, datetime) %>%
    dplyr::summarise(mean = mean(val),
                     sd = sd(val))
```

```{r, echo=FALSE, fig.height=6}
  fp_conf %>%
    ggplot(aes(x = datetime, y = mean, color = mean)) +
    geom_point() +
    geom_line() +
    geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd)) +
    theme_minimal() +
    theme(legend.position = "none") +
    facet_wrap(.~hh_id, scales = "free") +
    xlab("") +
    ylab("firepower estimate")
```

# Compare predictions to actual data

Not sure which is the best way to average

## Type 1 averaging

Group by the test event then find the mean and standard deviation of all observations

```{r}
  fp_sum1 <-
    fp_data %>%
    dplyr::group_by(hh_id, stove) %>%
    dplyr::summarise(mean = mean(val),
                     sd = sd(val))
```

Plot of estimated firepower (colored) and actual firepowers (black)

```{r, echo=FALSE}
  fp_sum1 %>%
    ggplot(aes(x = hh_id, y = mean, color = hh_id)) +
    geom_point(size = 3) +
    geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd)) +
    geom_point(data = fp %>%
                 dplyr::filter(grepl("11|17|18|23|34", hh_id)),
               aes(x = hh_id, y = fp), shape = 8, color = "black", size = 3) +
    theme_minimal() +
    theme(legend.position = "none") +
    xlab("") +
    ylab("firepower estimate") +
    ylim(0, 6)
```

## Type 2 averaging

Group by temperature observation find the mean, then group by the cooking event and find the mean and standard deviation

```{r}
  fp_sum2 <-
    fp_data %>%
    dplyr::group_by(hh_id, stove, datetime) %>%
    dplyr::summarise(val = mean(val)) %>%
    dplyr::ungroup() %>%
    dplyr::group_by(hh_id, stove) %>%
    dplyr::summarise(mean = mean(val),
                     sd = sd(val))
```

Plot of estimated firepower (colored) and actual firepowers (black)

```{r, echo=FALSE}
  fp_sum2 %>%
    ggplot(aes(x = hh_id, y = mean, color = hh_id)) +
    geom_point(size = 3) +
    geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd)) +
    geom_point(data = fp %>%
                 dplyr::filter(grepl("11|17|18|23|34", hh_id)),
               aes(x = hh_id, y = fp), shape = 8, color = "black", size = 3) +
    theme_minimal() +
    theme(legend.position = "none") +
    xlab("") +
    ylab("firepower estimate") +
    ylim(0, 6)
```

# Scale firepower estimates to actual data

```{r}
  fp_scale <-
    fp_sum1 %>%
    dplyr::left_join(dplyr::select(fp, hh_id, fp), by = "hh_id") %>%
    dplyr::mutate(scale = fp / mean) %>%
    dplyr::select(hh_id, scale)
```

Plot scaling factor

```{r, echo=FALSE}
  fp_scale %>%
  ggplot(aes(x = hh_id, y = scale, color = hh_id)) +
    geom_point(size = 3, shape = 1, stroke = 2) +
    theme_minimal() +
    theme(legend.position = "none") +
    xlab("") +
    ylab("scaling factor")
```

Plot scaled firepower data

Use standard deviation of the random samples as confidence intervals????

```{r}
  fp_conf2 <-
    fp_data %>%
    dplyr::group_by(hh_id, stove, datetime) %>%
    dplyr::left_join(fp_scale, by = "hh_id") %>%
    dplyr::mutate(val = val * scale) %>%
    dplyr::summarise(mean = mean(val),
                     sd = sd(val))
```

```{r, echo=FALSE, fig.height=6}
  fp_conf2 %>%
    ggplot(aes(x = datetime, y = mean, color = mean)) +
    geom_point() +
    geom_line() +
    geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd)) +
    theme_minimal() +
    theme(legend.position = "none") +
    facet_wrap(.~hh_id, scales = "free") +
    xlab("") +
    ylab("firepower estimate")
```

## Double check approach

Group by temperature observation find the mean, then group by the cooking event and find the mean and standard deviation

```{r}
  fp_sum_scale <-
    fp_data %>%
    dplyr::group_by(hh_id, stove, datetime) %>%
    dplyr::left_join(fp_scale, by = "hh_id") %>%
    dplyr::mutate(val = val * scale) %>%
    dplyr::summarise(val = mean(val)) %>%
    dplyr::ungroup() %>%
    dplyr::group_by(hh_id, stove) %>%
    dplyr::summarise(mean = mean(val),
                     sd = sd(val))
```

Plot of estimated firepower (colored) and actual firepowers (black)

```{r, echo=FALSE}
  fp_sum_scale %>%
    ggplot(aes(x = hh_id, y = mean, color = hh_id)) +
    geom_point(size = 3) +
    geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd)) +
    geom_point(data = fp %>%
                 dplyr::filter(grepl("11|17|18|23|34", hh_id)),
               aes(x = hh_id, y = fp), shape = 8, color = "black", size = 3) +
    theme_minimal() +
    theme(legend.position = "none") +
    xlab("") +
    ylab("firepower estimate")
```

Good estimate falls exactly on the average

# Save scaled bootstrap data

```{r, echo=FALSE}
  fp_scale <-
    fp_data %>%
    dplyr::group_by(hh_id, stove, datetime) %>%
    dplyr::left_join(fp_scale, by = "hh_id") %>%
    dplyr::mutate(val = val * scale)

  saveRDS(fp_scale, "../r_files/fp_scale.RDS")
```