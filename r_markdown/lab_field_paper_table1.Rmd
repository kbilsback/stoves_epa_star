---
title: "Figure 1: Scatter plots of temperature vs. firepower"
output:
  html_document:
    toc: yes
---

```{r load_libraries, echo=FALSE, message=FALSE}
  if (!require("pacman")) install.packages("pacman")
  pacman::p_load(tidyverse, patchwork, weathermetrics, lmerTest,
                 lme4, MuMIn, merTools, Matrix, mvtnorm, matrixcalc)
  options(knitr.table.format = "latex")
```

```{r global_options, include=FALSE}
  knitr::opts_chunk$set(fig.path = 'figures/', warning = FALSE,
                        message = FALSE, cache = FALSE)
```

# Import data

```{r}
  lab_temp_fp <- readRDS("../r_files/lab_temp_fp_merged.RDS")
  field_temp <- readRDS("../r_files/india_temp_merged.RDS")
  field_fp <- readRDS("../r_files/field_firepower.RDS")
  field_samples <- readRDS("../r_files/field_samples.RDS")
```

# 1. Pre-process lab-derived temperature data

Before analysis data were:

1. Quality control checked
2. Start-up and shut-down events were removed
3. Ambient temperature was subtracted
4. Data are time-averaged and synced
5. Data that were less than twice the average ambient temperature were removed

* Analysis conducted in seperate file

# 2. Compare lab-derived temperature versus firepower models for continuous-feed stoves

## Scale temperature data using both data from lab and field

Log-transform lab-derived temperature data

```{r}
  continuous_temp_fp <-
    lab_temp_fp %>%
    dplyr::filter(grepl("continuous", fst_type), !grepl("plancha", stove)) #%>%
    #dplyr::mutate(temp = scale(temp))
```

## Run model with log-transformed response

Model summary:

```{r}
  mod1 = lm(log(firepower) ~ temp*stove, data = continuous_temp_fp)
  summary(mod1)
```

Residual Plot:

* Log-transformed response improves residuals

```{r, echo=FALSE}
  plot(mod1, 5)
```

Leverage Plot:

* Outliers do not appear to be high-leverage

```{r, echo=FALSE}
  plot(mod1, 5)
```

```{r, fig.height=4, echo=FALSE}
  ggplot(data = continuous_temp_fp, aes(y = log(firepower), x = temp)) +
    geom_point(shape = 1, size = 0.5) +
    geom_smooth(method = lm) +
    facet_wrap(.~stove, scales = "free")
```

## Run second-order linear model with log-transformed response

Model summary:

```{r}
  mod2 = lm(log(firepower) ~ poly(temp, 2)*stove, data = continuous_temp_fp)
  summary(mod2)
```

Residual Plot:

* Polynomial fit doesn't improve residuals much

```{r}
  plot(mod2, 1)
```

```{r, fig.height=4, echo=FALSE}
  ggplot(data = continuous_temp_fp, aes(y = log(firepower), x = temp)) +
    geom_point(shape = 1, size = 0.5) +
    geom_smooth(method = lm, formula = y ~ poly(x, 2)) +
    facet_wrap(.~stove, scales = "free")
```

```{r}
  anova(mod1, mod2)
```

```{r}
  model.sel(mod1, mod2)
```

## Run mixed-effects models

```{r}
  mod3 <- lmer(log(firepower) ~ temp*stove + (1 | id), data = continuous_temp_fp, REML = FALSE)
  summary(mod3)
```

```{r}
  mod4 <- lmer(log(firepower) ~ temp*stove + (1 + temp| id), data = continuous_temp_fp, REML = FALSE)
  summary(mod4)
```

## Compare mixed- and fixed-effect models

```{r}
  anova(mod4, mod1)
```

```{r}
  model.sel(mod4, mod3, mod2, mod1)
```

# 2. Compare lab-derived temperature versus firepower models for batch-fed stoves

## Scale temperature data using both data from lab and field

Log-transform lab-derived temperature data

```{r}
  batch_temp_fp <-
    lab_temp_fp %>%
    dplyr::filter(grepl("batch", fst_type)) %>%
    dplyr::mutate(temp = scale(temp))
```

## Run model with log-transformed response

Model summary:

```{r}
  mod1 = lm(log(firepower) ~ temp*stove, data = batch_temp_fp)
  summary(mod1)
```

Residual Plot:

* Log-transformed response improves residuals

```{r, echo=FALSE}
  plot(mod1, 1)
```

Leverage Plot:

* Outliers do not appear to be high-leverage

```{r, echo=FALSE}
  plot(mod1, 5)
```

## Run second-order linear model with log-transformed response

Model summary:

```{r}
  mod2 = lm(log(firepower) ~ poly(temp, 2)*stove, data = batch_temp_fp)
  summary(mod2)
```

Residual Plot:

* Polynomial fit doesn't improve residuals much

```{r}
  plot(mod2, 1)
```

## Run mixed-effects models

```{r}
  mod3 <- lmer(log(firepower) ~ temp*stove + (1 | id), data = batch_temp_fp, REML = FALSE)
  summary(mod3)
```

```{r}
  mod4 <- lmer(log(firepower) ~ temp*stove + (1 + temp| id), data = batch_temp_fp, REML = FALSE)
  summary(mod4)
```

## Compare mixed- and fixed-effect models

```{r}
  anova(mod2, mod1)
```

```{r}
  model.sel(mod4, mod3, mod2, mod1)
```