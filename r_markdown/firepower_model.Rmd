---
title: "Build firepower model"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r load_libraries, echo=FALSE, message=FALSE}
  library(tidyverse)
  library(lme4)
  library(broom)
  library(psych)
  library(MuMIn)
```

```{r global_options, include=FALSE}
  knitr::opts_chunk$set(fig.path='figures/', warning=FALSE, message=FALSE, cache=FALSE)
```

```{r, echo=FALSE}
  grav <- readRDS("../r_files/lab_grav_merged.RDS")
```

# Summary

Fixed effects (predictors) of interest:

* stove/fuel combination
* firepower (firepower = burn rate*constant)
* combustion efficiency
* burn rate

Outcomes of interest:

* black carbon
* particulate matter
* carbon monoxide

metrics to look at include: emissions factors and emissions rates

Random effects (controls) of interest:

* test condition
* day the test was conducted
* tester
* replicate number

```{r, echo=FALSE}
  # Organize the fixed predictors
  fix_predict <-
    grav %>%
    dplyr::filter(id != "3B", fuel != "okote", grepl("fp|mce", var)) %>%
    dplyr::mutate("stove_fuel" = paste(stove, fuel)) %>%
    dplyr::select(test_type, id, sample_id, var, val, stove_fuel, stove, fuel, lhv) %>%
    tidyr::spread(var, val) %>%
    dplyr::mutate(burn_rate = fp / lhv * 1e6) %>%
    dplyr::select(-lhv) %>%
    dplyr::mutate(stove_fuel = forcats::as_factor(stove_fuel),
                  stove = forcats::as_factor(stove),
                  fuel = forcats::as_factor(fuel),
                  test_type = forcats::as_factor(test_type),
                  sample_id = forcats::as_factor(sample_id)) %>%
    dplyr::group_by(test_type)
```

```{r, echo=FALSE}
  # Organize the outcomes
  outcomes <-
    grav %>%
    dplyr::filter(id != "3B", fuel != "okote", grepl("pm_ef|bc_ef|co_ef|pm_rate|bc_rate|co_rate", var)) %>%
    dplyr::mutate("stove_fuel" = paste(stove, fuel)) %>%
    dplyr::select(test_type, id, sample_id, var, val) %>%
    tidyr::spread(var, val) %>%
    dplyr::mutate(test_type = forcats::as_factor(test_type),
                  sample_id = forcats::as_factor(sample_id)) %>%
    dplyr::group_by(test_type)
```

```{r, echo=FALSE}
  # Organize the outcomes
  rand_predict <-
    grav %>%
    dplyr::filter(id != "3B", fuel != "okote") %>%
    dplyr::mutate(rep = gsub("*[0-9]", "", id),
                  day = as.numeric(format(as.Date(date,format="%Y-%m-%d"), "%d")) - 4) %>%
    dplyr::select(test_type, id, sample_id, day, rep, tester) %>%
    dplyr::mutate(test_type = forcats::as_factor(test_type),
                  sample_id = forcats::as_factor(sample_id),
                  day = forcats::as_factor(as.character(day))) %>%
    dplyr::group_by(test_type)
```

# Descriptive statistics

## Fixed effects

```{r, echo=FALSE}
  describeBy(dplyr::select(fix_predict, fp, mce, burn_rate, test_type), group = "test_type")
```

```{r, echo=FALSE}
  fix_predict %>%
  tidyr::gather("var", "val", 7:9) %>%
  ggplot(aes(val)) +
    theme_bw() +
    geom_histogram() +
    facet_wrap(~var, scales = "free")
```

## Random effects

```{r, echo=FALSE}
  describeBy(dplyr::select(rand_predict, sample_id, day, tester, rep, test_type), group = "test_type")
```

```{r, echo=FALSE}
  rand_predict %>%
    tidyr::gather("var", "val", 3:6) %>%
    ggplot(aes(val)) +
      theme_bw() +
      geom_histogram(stat = "count") +
      facet_wrap(~var, scales = "free")
```

## Outcomes

```{r, echo=FALSE}
  describeBy(dplyr::select(outcomes, bc_ef, bc_rate, pm_ef, pm_rate, co_ef, test_type), group = "test_type")
```

```{r, echo=FALSE}
  outcomes %>%
    tidyr::gather("var", "val", 4:8) %>%
    ggplot(aes(val)) +
      theme_bw() +
      geom_histogram() +
      facet_wrap(~var, scales = "free")
```

# Fixed effects

Does it look like the slope is different for each stove/fuel combination?
Conclusion:

```{r, echo=FALSE, fig.height=12}
  fix_predict %>%
    dplyr::left_join(outcomes, by = c("id", "sample_id", "test_type")) %>%
    tidyr::gather("var", "val", 10:14) %>%
    ggplot(aes(x = fp, y = val, color = stove_fuel)) +
      geom_point(shape = 1) +
      geom_smooth(method = "lm", se = FALSE, alpha = 0.5) +
      theme_bw() +
      theme(legend.position = "none") +
      facet_wrap(var~test_type, ncol = 3, scales = "free") +
      xlab("Firepower") +
      ylab("")
```

Does it look like the slope is different for each stove/fuel combination?
Conclusion: 

```{r, echo=FALSE, fig.height=12}
  fix_predict %>%
    dplyr::left_join(outcomes, by = c("id", "sample_id", "test_type")) %>%
    tidyr::gather("var", "val", 10:14) %>%
    ggplot(aes(x = mce, y = val, color = stove_fuel)) +
      geom_point(shape = 1) +
      geom_smooth(method = "lm", se = FALSE, alpha = 0.5) +
      theme_bw() +
      theme(legend.position = "none") +
      facet_wrap(var~test_type, ncol = 3, scales = "free") +
      xlab("Modified combustion efficiency") +
      ylab("")
```

```{r, echo=FALSE, fig.height=12}
  fix_predict %>%
    dplyr::left_join(outcomes, by = c("id", "sample_id", "test_type")) %>%
    tidyr::gather("var", "val", 10:14) %>%
    ggplot(aes(x = burn_rate, y = val, color = stove_fuel)) +
      geom_point(shape = 1) +
      geom_smooth(method = "lm", se = FALSE, alpha = 0.5) +
      theme_bw() +
      theme(legend.position = "none") +
      facet_wrap(var~test_type, ncol = 3, scales = "free") +
      xlab("Burn rate") +
      ylab("")
```

# Models

Models of interest:

* mod1: emissions ~ fp
* mod2: emissions ~ mce
*  mod3: emissions ~ burn_rate
*  mod4: emissions ~ fp + mce
*  mod5: emissions ~ burn_rate + mce
*  mod6: emissions ~ burn_rate + mce + fp
*  mod7: emissions ~ fp*stove_fuel + fp + stove_fuel
*  mod8: emissions ~ burn_rate*stove_fuel + burn_rate + stove_fuel
*  mod9: emissions ~ mce*stove_fuel + mce + stove_fuel
*  mod10: emissions ~ fp\*stove_fuel + mce\*stove_fuel + fp + mce + stove_fuel
*  mod11: emissions ~ burn_rate\*stove_fuel + mce\*stove_fuel + burn_rate + mce + stovefuel
*  mod12: emissions ~ burn_rate\*stove_fuel + mce\*stove_fuel + burn_rate + mce + fp + fp\*stove_fuel + stove_fuel

```{r, echo=FALSE}
  data <- fix_predict %>%
          dplyr::left_join(outcomes, by = c("id", "sample_id", "test_type")) 
```

## Particulate matter emissions factor

Continuous-feed wood stoves

```{r, echo=FALSE}
  mod_data <-
    data %>%
    dplyr::filter(test_type == "continuous-feed\nwood protocol")

  mod1 = lm(pm_ef ~ fp, data = mod_data)
  mod2 = lm(pm_ef ~ mce, data = mod_data)
  mod3 = lm(pm_ef ~ burn_rate, data = mod_data)
  mod4 = lm(pm_ef ~ fp + mce, data = mod_data)
  mod5 = lm(pm_ef ~ burn_rate + mce, data = mod_data)
  mod6 = lm(pm_ef ~ burn_rate + mce + fp, data = mod_data)
  mod7 = lm(pm_ef ~ fp*stove_fuel, data = mod_data)
  mod8 = lm(pm_ef ~ burn_rate*stove_fuel, data = mod_data)
  mod9 = lm(pm_ef ~ mce*stove_fuel, data = mod_data)
  mod10 = lm(pm_ef ~ fp*stove_fuel + mce*stove_fuel + fp + mce, data = mod_data)
  mod11 = lm(pm_ef ~ burn_rate*stove_fuel + mce*stove_fuel + burn_rate + mce, data = mod_data)
  mod12 = lm(pm_ef ~ burn_rate*stove_fuel + mce*stove_fuel + burn_rate + mce + fp + fp*stove_fuel, data = mod_data)

  results <- model.sel(mod1, mod2, mod3, mod4, mod5, mod6, mod7, mod8, mod9, mod10, mod11, mod12)
  results <- summary(mod7)
  results$r.squared
```

is the R^2 of Model 7.

Batch-fed wood protocol

```{r, echo=FALSE}
  mod_data <-
    data %>%
    dplyr::filter(test_type == "batch-fed\nwood protocol")

  mod1 = lm(pm_ef ~ fp, data = mod_data)
  mod2 = lm(pm_ef ~ mce, data = mod_data)
  mod3 = lm(pm_ef ~ burn_rate, data = mod_data)
  mod4 = lm(pm_ef ~ fp + mce, data = mod_data)
  mod5 = lm(pm_ef ~ burn_rate + mce, data = mod_data)
  mod6 = lm(pm_ef ~ burn_rate + mce + fp, data = mod_data)
  mod7 = lm(pm_ef ~ fp*stove_fuel, data = mod_data)
  mod8 = lm(pm_ef ~ burn_rate*stove_fuel, data = mod_data)
  mod9 = lm(pm_ef ~ mce*stove_fuel, data = mod_data)
  mod10 = lm(pm_ef ~ fp*stove_fuel + mce*stove_fuel + fp + mce, data = mod_data)
  mod11 = lm(pm_ef ~ burn_rate*stove_fuel + mce*stove_fuel + burn_rate + mce, data = mod_data)
  mod12 = lm(pm_ef ~ burn_rate*stove_fuel + mce*stove_fuel + burn_rate + mce + fp + fp*stove_fuel, data = mod_data)

  results <- model.sel(mod1, mod2, mod3, mod4, mod5, mod6, mod7, mod8, mod9, mod10, mod11, mod12)
  results <- summary(mod3)
  results$r.squared
```

is the R^2 of Model 3.

Batch-fed charcoal protocol

```{r, echo=FALSE}
  mod_data <-
    data %>%
    dplyr::filter(test_type == "batch-fed\ncharcoal protocol")

  mod1 = lm(pm_ef ~ fp, data = mod_data)
  mod2 = lm(pm_ef ~ mce, data = mod_data)
  mod3 = lm(pm_ef ~ burn_rate, data = mod_data)
  mod4 = lm(pm_ef ~ fp + mce, data = mod_data)
  mod5 = lm(pm_ef ~ burn_rate + mce, data = mod_data)
  mod6 = lm(pm_ef ~ burn_rate + mce + fp, data = mod_data)
  mod7 = lm(pm_ef ~ fp*stove_fuel, data = mod_data)
  mod8 = lm(pm_ef ~ burn_rate*stove_fuel, data = mod_data)
  mod9 = lm(pm_ef ~ mce*stove_fuel, data = mod_data)
  mod10 = lm(pm_ef ~ fp*stove_fuel + mce*stove_fuel + fp + mce, data = mod_data)
  mod11 = lm(pm_ef ~ burn_rate*stove_fuel + mce*stove_fuel + burn_rate + mce, data = mod_data)
  mod12 = lm(pm_ef ~ burn_rate*stove_fuel + mce*stove_fuel + burn_rate + mce + fp + fp*stove_fuel, data = mod_data)

  results <- model.sel(mod1, mod2, mod3, mod4, mod5, mod6, mod7, mod8, mod9, mod10, mod11, mod12)
  results <- summary(mod2)
  results$r.squared
```

is the R^2 of Model 2.

## Black carbon emissions factor

Continuous-feed wood protocol

```{r, echo=FALSE}
  mod_data <-
    data %>%
    dplyr::filter(test_type == "continuous-feed\nwood protocol")

  mod1 = lm(bc_ef ~ fp, data = mod_data)
  mod2 = lm(bc_ef ~ mce, data = mod_data)
  mod3 = lm(bc_ef ~ burn_rate, data = mod_data)
  mod4 = lm(bc_ef ~ fp + mce, data = mod_data)
  mod5 = lm(bc_ef ~ burn_rate + mce, data = mod_data)
  mod6 = lm(bc_ef ~ burn_rate + mce + fp, data = mod_data)
  mod7 = lm(bc_ef ~ fp*stove_fuel, data = mod_data)
  mod8 = lm(bc_ef ~ burn_rate*stove_fuel, data = mod_data)
  mod9 = lm(bc_ef ~ mce*stove_fuel, data = mod_data)
  mod10 = lm(bc_ef ~ fp*stove_fuel + mce*stove_fuel + fp + mce, data = mod_data)
  mod11 = lm(bc_ef ~ burn_rate*stove_fuel + mce*stove_fuel + burn_rate + mce, data = mod_data)
  mod12 = lm(bc_ef ~ burn_rate*stove_fuel + mce*stove_fuel + burn_rate + mce + fp + fp*stove_fuel, data = mod_data)

  results <- model.sel(mod1, mod2, mod3, mod4, mod5, mod6, mod7, mod8, mod9, mod10, mod11, mod12)
  results <- summary(mod7)
  results$r.squared
```

is the R^2 of Model 7.

## Black carbon emissions rate

Continuous-feed wood protocol

```{r, echo=FALSE}
  mod_data <-
    data %>%
    dplyr::filter(test_type == "continuous-feed\nwood protocol")

  mod1 = lm(bc_rate ~ fp, data = mod_data)
  mod2 = lm(bc_rate ~ mce, data = mod_data)
  mod3 = lm(bc_rate ~ burn_rate, data = mod_data)
  mod4 = lm(bc_rate ~ fp + mce, data = mod_data)
  mod5 = lm(bc_rate ~ burn_rate + mce, data = mod_data)
  mod6 = lm(bc_rate ~ burn_rate + mce + fp, data = mod_data)
  mod7 = lm(bc_rate ~ fp*stove_fuel, data = mod_data)
  mod8 = lm(bc_rate ~ burn_rate*stove_fuel, data = mod_data)
  mod9 = lm(bc_rate ~ mce*stove_fuel, data = mod_data)
  mod10 = lm(bc_rate ~ fp*stove_fuel + mce*stove_fuel + fp + mce, data = mod_data)
  mod11 = lm(bc_rate ~ burn_rate*stove_fuel + mce*stove_fuel + burn_rate + mce, data = mod_data)
  mod12 = lm(bc_rate ~ burn_rate*stove_fuel + mce*stove_fuel + burn_rate + mce + fp + fp*stove_fuel, data = mod_data)

  results <- model.sel(mod1, mod2, mod3, mod4, mod5, mod6, mod7, mod8, mod9, mod10, mod11, mod12)
  results <- summary(mod7)
  results$r.squared
```

is the R^2 of Model 7.

```{r, echo=FALSE}
  # fix_predict %>%
  #   dplyr::left_join(outcomes, by = c("id", "sample_id", "test_type")) %>%
  #   nest(-test_type) %>%
  #   mutate(fit = map(data, ~ lm(pm_ef ~ stove_fuel*fp*mce*burn_rate, data = .)),
  #          results = map(fit, glance)) %>%
  #   unnest(results) %>%
  #   ggplot(aes(x = factor(test_type), y = r.squared)) +
  #     geom_bar(stat = "identity") +
  #     theme_bw() +
  #     labs(x = "test type", y = expression(R^{2}))
```

```{r, echo=FALSE}
  # fix_predict %>%
  #   dplyr::left_join(outcomes, by = c("id", "sample_id", "test_type")) %>%
  #   nest(-test_type) %>%
  #   mutate(fit = map(data, ~ lm(pm_rate ~ stove_fuel*fp*mce*burn_rate, data = .)),
  #          results = map(fit, glance)) %>%
  #   unnest(results) %>%
  #   ggplot(aes(x = factor(test_type), y = r.squared)) +
  #     geom_bar(stat = "identity") +
  #     theme_bw() +
  #     labs(x = "test type", y = expression(R^{2}))
```

```{r, echo=FALSE}
  # fix_predict %>%
  #   dplyr::left_join(outcomes, by = c("id", "sample_id", "test_type")) %>%
  #   dplyr::filter(test_type == "continuous-feed\nwood protocol") %>%
  #   nest(-test_type) %>%
  #   mutate(fit = map(data, ~ lm(bc_ef ~ stove_fuel*fp*mce*burn_rate, data = .)),
  #          results = map(fit, glance)) %>%
  #   unnest(results) %>%
  #   ggplot(aes(x = factor(test_type), y = r.squared)) +
  #     geom_bar(stat = "identity") +
  #     theme_bw() +
  #     labs(x = "test type", y = expression(R^{2}))
```

```{r, echo=FALSE}
  # fix_predict %>%
  #   dplyr::left_join(outcomes, by = c("id", "sample_id", "test_type")) %>%
  #   nest(-test_type) %>%
  #   mutate(fit = map(data, ~ lm(bc_rate ~ stove_fuel*fp*mce*burn_rate, data = .)),
  #          results = map(fit, glance)) %>%
  #   unnest(results) %>%
  #   ggplot(aes(x = factor(test_type), y = r.squared)) +
  #     geom_bar(stat = "identity") +
  #     theme_bw() +
  #     labs(x = "test type", y = expression(R^{2}))
```

```{r, echo=FALSE}
  # fix_predict %>%
  #   dplyr::left_join(outcomes, by = c("id", "sample_id", "test_type")) %>%
  #   nest(-test_type) %>%
  #   mutate(fit = map(data, ~ lm(co_ef ~ stove_fuel*fp*mce*burn_rate, data = .)),
  #          results = map(fit, glance)) %>%
  #   unnest(results) %>%
  #   ggplot(aes(x = factor(test_type), y = r.squared)) +
  #     geom_bar(stat = "identity") +
  #     theme_bw() +
  #     labs(x = "test type", y = expression(R^{2}))
```

# Random (control?) effects

```{r, echo=FALSE, eval=FALSE}
  # test <-
  #   pm_ef %>% 
  #     nest(-test_type) %>% 
  #     mutate(fit = map(data, ~ lm(pm_ef ~ sample_id + date + tester + rep, data = .)),
  #            results = map(fit, summary)) %>% 
  #     unnest(results)
  # 
  #   ggplot(pm_ef, aes(x = factor(test_type), y = r.squared)) +
  #     geom_bar(stat = "identity") +
  #     labs(x = "test type", y = expression(R^{2}))
```

* center all predictors on the mean

```{r}
  # pm_ef <-
  #   pm_ef %>%
  #   dplyr::mutate(pm_ef = scale(pm_ef, center = TRUE),
  #                 fp = scale(fp, center = TRUE),
  #                 mce = scale(mce, center = TRUE))
```
