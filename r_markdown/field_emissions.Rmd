---
title: "Field emissions factors"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r load_libraries, include=FALSE}
  library(tidyverse)
  library(knitr)
```

```{r global_options, include=FALSE}
  knitr::opts_chunk$set(fig.path ='figures/', warning = FALSE, message = FALSE, cache = FALSE, tidy = TRUE)
```

# Load files

* functions 

```{r functions}
  source("../r_scripts/functions.R")
  source("../r_scripts/plots.R")
```

* pollutant data

```{r load_data}
  temp <- readRDS("../r_files/field_temp_merged.RDS")
  grav <- readRDS("../r_files/field_grav_merged.RDS")
  aqe <- readRDS("../r_files/field_aqe_merged.RDS")
  aqe_bkgd <- readRDS("../r_files/field_aqe_bkgd.RDS")
```

* constants

```{r load_constants}
  fuel_properties <- readRDS("../r_files/fuel_properties.RDS")
  pol_properties <- readRDS("../r_files/pol_properties.RDS")
```

* metadata

```{r load_metadata}
  times <- readRDS("../r_files/field_test_times.RDS")
  samples <- readRDS("../r_files/field_samples.RDS")
  fuel_wgts <- readRDS("../r_files/field_fuel_wgts.RDS")
```

# Gas analyzer

* calculate test average

```{r aqe_test_avg}
  aqe <- aqe %>%
         dplyr::group_by(hh_id, var) %>%
         dplyr::summarise(mix_ratio = mean(val, na.rm = TRUE),
                          units = first(units),
                          qc = first(qc)) %>%
        dplyr::ungroup()
```

* subtract background 

```{r sub_bkgd}
  aqe <- aqe %>%
         dplyr::left_join(dplyr::select(aqe_bkgd$mean, hh_id, var, val), by = c("var", "hh_id")) %>%
         dplyr::rename(bkgd_mix_ratio = val) %>%
         dplyr::mutate(mix_ratio = mix_ratio - bkgd_mix_ratio) %>%
         dplyr::select(-bkgd_mix_ratio)
```

* update test qc based on background qc

```{r update_qc}
  # add code for this
```

* convert mixing ratios to mass conc (assuming constant T and P)

```{r calc_mass_conc}
  aqe <- aqe %>%
         dplyr::left_join(pol_properties, by = c("var" = "pol")) %>%
         dplyr::mutate(mass_conc = convert_ppmv_ugm3(ppmv = mix_ratio, mw = mw)) %>%
         dplyr::select(-units)
```

* calculate the mass concentration of carbon

```{r calc_carbon}
  aqe <- aqe %>%
         dplyr::mutate(carbon_mass_conc = mass_conc * (mw_c() * num_c / mw))
```

* tidy aqe data

```{r tidy_aqe}
  aqe <- aqe %>%
         dplyr::select(hh_id, var, qc, mix_ratio, mass_conc, carbon_mass_conc) %>%
         dplyr::rename(pol = var) %>%
         tidyr::gather("var", "val", 4:6) %>%
         dplyr::mutate(units = "ppmv",
                       units = if_else(var == "mass_conc", "ug_m3", units),
                       units = if_else(var == "carbon_mass_conc", "ug_m3 of carbon", units))
```

# Gravimetric data

```{r}
  
```

# Combine test metadata

* extract sample data

```{r extract_test_meta}
  metadata <- samples %>%
              dplyr::select(-date)
```

* extract test duration

```{r add_test_time}
  dur <- times %>%
         dplyr::filter(var == "dur") %>%
         tidyr::spread(var, value) %>%
         dplyr::select(hh_id, dur) 
```

* extract test duration

```{r add_test_time}
  fuel_avg <- fuel_properties %>%
               dplyr::group_by(fuel, var) %>%
               dplyr::filter(qc != "bad") %>%
               dplyr::summarise(val = mean(val), qc = first(qc))

  fuel <- fuel_properties %>%
          dplyr::group_by(hh_id, fuel, var) %>%
          dplyr::summarise(val = mean(val),
                           qc = first(qc)) %>%
          tidyr::spread(var, val) %>%
          dplyr::right_join(dplyr::select(samples, fuel_type, hh_id),
                            by = c("fuel" = "fuel_type", "hh_id")) %>%
          dplyr::right_join(fuel_avg, by = c("val", "fuel"))

                   
```

* combine all metadata

```{r combine_meta}
  metadata <- metadata %>%
              dplyr::left_join(dur, by = "hh_id") %>%
              tidyr::gather("var", "val", 3:5) %>%
              dplyr::bind_rows(fuel)
```


# Merge with fuel burnt