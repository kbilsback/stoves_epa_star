---
title: "Lab to field model"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r global_options, include=FALSE}
  knitr::opts_chunk$set(fig.path='figures/', warning=FALSE, message=FALSE, cache=FALSE)
```

```{r load_libraries, echo=FALSE}
  library(tidyverse)
  library(lme4)
  library(plyr)
  library(broom)
  library(MASS)
```

# Load files

* data

```{r load_data, echo=FALSE}
  lab_grav <- readRDS("../r_files/lab_grav_merged.RDS")
```

* functions

```{r load_functions, echo=FALSE}
  source("../r_scripts/models.R")
  source("../r_scripts/functions.R")
```

* metadata

```{r load_meta, echo=FALSE}
  lab_samples <- readRDS("../r_files/lab_meta.RDS")
  field_samples <- readRDS("../r_files/field_meta.RDS")
```

# Tidy data

* remove start up and shutdown
* select only wood tests

```{r, echo=FALSE}
  lab_data <- lab_grav %>%
              dplyr::select(-units) %>%
              tidyr::spread(var, val) %>% 
              dplyr::select(id, sample_id, pm_ef, bc_ef, pm_mass, bc_mass,
                            pm_rate, bc_rate, fp, mce) %>%
              tidyr::gather("pol", "val", 3:8) %>%
              dplyr::left_join(lab_samples, by = "id") %>%
              #dplyr::filter(sample_id != "start_up", sample_id != "shutdown") %>%
              dplyr::filter(fuel_type == "wood") %>%
              dplyr::filter(!is.na(val), !is.na(fp), !is.na(mce))
```

# Develop model using lab data

## PM2.5 emissions

# Firepower only model

```{r}
    f <- c("val ~ fp", "val ~ mce", "val ~ fp + mce + fp*mce")
    pols <- c("pm_ef", "pm_rate", "pm_mass", "bc_ef", "bc_rate", "bc_mass")
```

```{r, echo=FALSE}
  lapply(f, function(x) lapply(pols, function(x)
    plot_boxcox_model(data = lab_data, eqn = f, response = x)))
```

# MCE only model 

```{r}
    f <- "val ~ mce"
    pols <- c("pm_ef", "pm_rate", "pm_mass", "bc_ef", "bc_rate", "bc_mass")
```

```{r, echo=FALSE}
  lapply(pols, function(x) plot_boxcox_model(data = lab_data, eqn = f, response = x))
```

# Firepower and MCE model

```{r}
    f <- "val ~ fp + mce + fp*mce"
    pols <- c("pm_ef", "pm_rate", "pm_mass", "bc_ef", "bc_rate", "bc_mass")
```

```{r, echo=FALSE}
  lapply(pols, function(x) plot_boxcox_model(data = lab_data, eqn = f, response = x))
```
