---
title: "Lab to field model"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r global_options, include=FALSE}
  knitr::opts_chunk$set(fig.path='figures/', warning=FALSE, message=FALSE, cache=FALSE)
```

```{r load_libraries, echo=FALSE}
  library(tidyverse)
  library(lme4)
  library(plyr)
  library(broom)
  library(MASS)
```

# Load files

* data

```{r load_data, echo=FALSE}
  lab_grav <- readRDS("../r_files/lab_grav_merged.RDS")
```

* functions

```{r load_functions, echo=FALSE}
  source("../r_scripts/models.R")
  source("../r_scripts/functions.R")
```

* metadata

```{r load_meta, echo=FALSE}
  lab_samples <- readRDS("../r_files/lab_meta.RDS")
  field_samples <- readRDS("../r_files/field_meta.RDS")
```

# Develop model using lab data

* basic model 

```{r}
    f <- formula(val ~ fp + mce + fp*mce)
```

* tidy data

```{r, echo=FALSE}
  lab_data <- lab_grav %>%
              dplyr::select(-units) %>%
              tidyr::spread(var, val) %>% 
              dplyr::select(id, sample_id, pm_ef, bc_ef, pm_mass, bc_mass,
                            pm_rate, bc_rate, fp, mce) %>%
              tidyr::gather("pol", "val", 3:8) %>%
              dplyr::left_join(lab_samples, by = "id") %>%
              dplyr::filter(!is.na(val), !is.na(fp), !is.na(mce))
```

* select variable to model 

```{r}
  pm_ef <- lab_data %>%
           dplyr::filter(fuel_type == "wood") %>%
           dplyr::filter(pol == "pm_ef") %>%
           dplyr::group_by(stove)
```

* run linear model

```{r}
  m_pm_ef <- pm_ef %>%
             dplyr::do(model = lm(f, data = .))
```


* plot R^2 values by stove type

```{r, echo=FALSE}
  ggplot(m_pm_ef %>% broom::glance(model), aes(x = stove, y = r.squared)) +
    geom_point(aes(color = r.squared), size = 5) +
    ggtitle("pm_ef ~ fp + mce + fp:mce") +
    theme_bw() + 
    xlab("stove type") +
    ylab("R squared") +
    theme(text = element_text(size = 18), legend.position = "top",
          axis.text.x = element_text(angle = 45, hjust = 1))
```

* Box-Cox transformation 

```{r, fig.show="hide"}
  m2_pm_ef <- pm_ef %>% 
              dplyr::do(box_cox = MASS::boxcox(f, data = pm_ef)) %>%
              dplyr::mutate(trans = box_cox$x[which.max(box_cox$y)])
```
