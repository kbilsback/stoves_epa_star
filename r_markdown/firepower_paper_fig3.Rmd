---
title: "Figure 3 for Firepower Sweep Paper"
output:
  html_document:
    toc: true
    toc_float: true
    theme: paper
---

```{r load_libraries, echo=FALSE, message=FALSE}
  library(tidyverse)
```

```{r global_options, include=FALSE}
  knitr::opts_chunk$set(fig.path='figures/', warning=FALSE, message=FALSE, cache=FALSE, echo=FALSE)
```

```{r load_data}
  grav <- readRDS("../r_files/lab_grav_merged.RDS")
```

```{r}
  source("../r_scripts/functions.r")
```

```{r}
  grav <-
    grav %>%
    dplyr::filter(id != "3B", fuel != "okote")
```

```{r}
  grav <- 
    grav %>%
    dplyr::filter(grepl("pm_ef|co_ef|bc_ef", var), grepl("continuous", fst_type), !is.na(val), val > 0) %>%
    write_csv("../r_csv/firepower_sweep_data.csv")
```

```{r}
  continuous <- 
    grav %>%
    dplyr::filter(grepl("pm_ef|co_ef", var), grepl("continuous", fst_type), !is.na(val), val > 0) %>%
    dplyr::select(-units) %>%
    tidyr::spread(var, val) %>%
    dplyr::mutate(phase = as.character(sample_id),
                  phase = ifelse(grepl("start_up", sample_id), "start-up", phase),
                  phase = ifelse(grepl("shutdown", sample_id), "shut-down", phase),
                  phase = ifelse(grepl("1|2|3|4", sample_id), "sweep-up", phase),
                  phase = ifelse(grepl("5|6|7", sample_id), "sweep-down", phase),
                  phase = forcats::fct_relevel(phase,
                                               "start-up",
                                                "sweep-down",
                                                "sweep-up",
                                                "shut-down"),
                  stove = forcats::fct_relevel(stove,
                                               "three stone fire",
                                               "mud chulha",
                                               "metal grill",
                                               "rocket elbow",
                                               "ceramic plancha",
                                               "metal plancha"))
```

```{r}
  eqn1 <- by(continuous, continuous$stove, pm_sum)
  eqn1 <- data.frame(eq = unclass(eqn1), stove = names(eqn1)) %>%
          dplyr::filter(!is.na(eq))
  eqn2 <- by(continuous, continuous$stove, co_sum)
  eqn2 <- data.frame(eq = unclass(eqn2), stove = names(eqn2)) %>%
          dplyr::filter(!is.na(eq))
```

```{r}
  batch <- 
    grav %>%
    dplyr::filter(grepl("pm_ef|co_ef", var), grepl("batch", fst_type), !is.na(val), val > 0) %>%
    dplyr::select(-units) %>%
    tidyr::spread(var, val) %>%
    dplyr::mutate(phase = as.character(sample_id),
                  phase = ifelse(grepl("start_up", sample_id), "start-up", phase),
                  phase = ifelse(grepl("shutdown", sample_id), "shut-down", phase),
                  phase = ifelse(grepl("3", sample_id), "refuel", phase),
                  phase = ifelse(grepl("1|2", sample_id), "pre-refuel", phase),
                  phase = ifelse(grepl("4|5", sample_id), "post-refuel", phase)) %>%
  dplyr::mutate(stove = forcats::fct_relevel(stove,
                                             "ceramic jiko",
                                             "metal jiko",
                                             "forced-draft gasifier")) %>%
  dplyr::mutate(fuel = forcats::fct_relevel(fuel,
                                            "coconut (briquettes)",
                                            "hardwood (lump)",
                                            "eucalyptus (pellets)",
                                            "red oak (milled)")) %>%
  dplyr::mutate(phase = forcats::fct_relevel(phase,
                                              "start-up",
                                              "pre-refuel",
                                              "refuel",
                                              "post-refuel",
                                              "shut-down"))
```

# Plots

```{r fig_3a, fig.width=12, fig.height=6}
  continuous %>%
    ggplot(aes(x = pm_ef, y = co_ef, color = fuel)) +
      geom_point(aes(shape = phase), size = 3, alpha = 0.75, stroke = 1) +
      geom_text(data = eqn1, aes(x = 6, y = 3, label = eq),
                color = "black",  parse = TRUE, size = 4) +
      geom_text(data = eqn2, aes(x = 7, y = 1, label = eq),
                color = "black",  parse = TRUE, size = 4) +
      scale_color_manual(values = c("#999999", "#E69F00")) +
      scale_shape_manual(values = c(8, 1, 16, 4)) +
      guides(color = guide_legend(override.aes = list(size = 3, alpha = 0.75))) +
      theme_bw() + 
      theme(text = element_text(size = 16),
            strip.text.x = element_text(size = 16),
            strip.background = element_rect(fill = "white"),
            plot.title = element_text(hjust = 0.5),
            legend.position = "right") +
        facet_wrap(~ stove, nrow = 2) +
        ggtitle("Continuous-Feed Wood Stoves") +
        scale_x_continuous(breaks = c(0.1, 1, 10), trans = "log10") +
        scale_y_continuous(breaks = c(1, 10, 100), limits = c(0.75, 250), trans = "log10") +
        xlab(expression(paste(PM[2.5], " Emissions Factors (g/kg-fuel)"))) +
        ylab("CO Emissions Factors (g/kg-fuel)") +
        labs(shape = "", color = "")
```

```{r}
  batch2 <- dplyr::filter(batch, !is.na(pm_ef))
  

  eqn1 <- by(batch2, batch2$stove, pm_sum)
  eqn1 <- data.frame(eq = unclass(eqn1), stove = names(eqn1)) %>%
          dplyr::filter(!is.na(eq))
  eqn2 <- by(batch, batch$stove, co_sum)
  eqn2 <- data.frame(eq = unclass(eqn2), stove = names(eqn2)) %>%
          dplyr::filter(!is.na(eq))
```

```{r fig_3b, fig.width=12, fig.height=3.5}
  batch %>%
    ggplot(aes(x = pm_ef, y = co_ef, color = fuel)) +
      geom_point(aes(shape = phase), alpha = 0.75, size = 3, stroke = 1) +
      geom_text(data = eqn1, aes(x = 5, y = 1.5, label = eq),
                color = "black",  parse = TRUE, size = 4) +
      geom_text(data = eqn2, aes(x = 5, y = 0.5, label = eq),
                color = "black",  parse = TRUE, size = 4) +
      scale_color_manual(values = c("#7b3294", "#c2a5cf", "#a6dba0", "#008837")) +
      guides(color = guide_legend(override.aes = list(size = 3))) +
      scale_shape_manual(values = c(8, 1, 3, 16, 4)) +
      theme_bw() + 
      theme(text = element_text(size = 16),
            strip.text.x = element_text(size = 16),
            strip.background = element_rect(fill = "white"),
            plot.title = element_text(hjust = 0.5),
            legend.position = "right") +
        facet_wrap(~stove, nrow = 1) +
        scale_x_continuous(breaks = c(0.01, 0.1, 1, 10), limits = c(0.01, 50),
                           trans = "log10") +
        scale_y_continuous(breaks = c(1, 10, 100), limits = c(0.4, 250), trans = "log10") +
        ggtitle("Batch-Fed Stoves") +
        xlab(expression(paste(PM[2.5], " Emissions Factors (g/kg-fuel)"))) +
        ylab("CO Emissions Factors (g/kg-fuel)") +
        labs(color = "", shape = "")
```

# Statistics by test type

```{r}
  batch_charcoal <- 
    batch %>%
    dplyr::filter(grepl("coconut|hardwood", fuel), !is.na(pm_ef), !is.na(co_ef))
```

```{r}
  batch_gasifier <- 
    batch %>%
    dplyr::filter(!grepl("coconut|hardwood", fuel))
```

## Continuous-feed wood stoves

```{r}
  continuous %>%
    dplyr::summarise(#min_pm_ef = min(pm_ef),
                     #max_pm_ef = max(pm_ef),
                     #min_co_ef = min(co_ef),
                     #max_co_ef = max(co_ef),
                     median_pm_ef = round(median(pm_ef, na.rm = TRUE), 2),
                     q1_pm_ef = round(quantile(pm_ef, 0.25, na.rm = TRUE), 2),
                     q3_pm_ef = round(quantile(pm_ef, 0.75, na.rm = TRUE), 2),
                     median_co_ef = round(median(co_ef, na.rm = TRUE), 0),
                     q1_co_ef = round(quantile(co_ef, 0.25, na.rm = TRUE), 0),
                     q3_co_ef = round(quantile(co_ef, 0.75, na.rm = TRUE), 0)) %>%
    #dplyr::mutate(range_pm_ef = max_pm_ef - min_pm_ef,
    #              range_co_ef = max_co_ef - min_co_ef) %>%
    knitr::kable()
```

## Batch-fed charcoal stoves

```{r}
  batch_charcoal %>%
    dplyr::summarise(#min_pm_ef = min(pm_ef),
                     #max_pm_ef = max(pm_ef),
                     #min_co_ef = min(co_ef),
                     #max_co_ef = max(co_ef),
                     median_pm_ef = round(median(pm_ef, na.rm = TRUE), 2),
                     q1_pm_ef = round(quantile(pm_ef, 0.25, na.rm = TRUE), 2),
                     q3_pm_ef = round(quantile(pm_ef, 0.75, na.rm = TRUE), 2),
                     median_co_ef = round(median(co_ef, na.rm = TRUE), 0),
                     q1_co_ef = round(quantile(co_ef, 0.25, na.rm = TRUE), 0),
                     q3_co_ef = round(quantile(co_ef, 0.75, na.rm = TRUE), 0)) %>%
    #dplyr::mutate(range_pm_ef = max_pm_ef - min_pm_ef,
    #              range_co_ef = max_co_ef - min_co_ef) %>%
    knitr::kable()
```

## Batch-fed wood stoves

```{r}
  batch_gasifier %>%
    dplyr::summarise(#min_pm_ef = min(pm_ef),
                     #max_pm_ef = max(pm_ef),
                     #min_co_ef = min(co_ef),
                     #max_co_ef = max(co_ef),
                     median_pm_ef = round(median(pm_ef, na.rm = TRUE), 2),
                     q1_pm_ef = round(quantile(pm_ef, 0.25, na.rm = TRUE), 2),
                     q3_pm_ef = round(quantile(pm_ef, 0.75, na.rm = TRUE), 2),
                     median_co_ef = round(median(co_ef, na.rm = TRUE), 0),
                     q1_co_ef = round(quantile(co_ef, 0.25, na.rm = TRUE), 0),
                     q3_co_ef = round(quantile(co_ef, 0.75, na.rm = TRUE), 0)) %>%
    #dplyr::mutate(range_pm_ef = max_pm_ef - min_pm_ef,
    #              range_co_ef = max_co_ef - min_co_ef) %>%
    knitr::kable()
```

# Statistics by stove type and stove category

## Continuous-feed wood stoves

```{r}
  continuous %>%
    dplyr::group_by(stove) %>%
    dplyr::summarise(#min_pm_ef = min(pm_ef),
                     #max_pm_ef = max(pm_ef),
                     #min_co_ef = min(co_ef),
                     #max_co_ef = max(co_ef),
                     median_pm_ef = round(median(pm_ef, na.rm = TRUE), 2),
                     q1_pm_ef = round(quantile(pm_ef, 0.25, na.rm = TRUE), 2),
                     q3_pm_ef = round(quantile(pm_ef, 0.75, na.rm = TRUE), 2),
                     median_co_ef = round(median(co_ef, na.rm = TRUE), 0),
                     q1_co_ef = round(quantile(co_ef, 0.25, na.rm = TRUE), 0),
                     q3_co_ef = round(quantile(co_ef, 0.75, na.rm = TRUE), 0)) %>%
    #dplyr::mutate(range_pm_ef = max_pm_ef - min_pm_ef,
    #              range_co_ef = max_co_ef - min_co_ef) %>%
    knitr::kable()
```

```{r}
  continuous %>%
    dplyr::group_by(stove_cat) %>%
    dplyr::summarise(#min_pm_ef = min(pm_ef),
                     #max_pm_ef = max(pm_ef),
                     #min_co_ef = min(co_ef),
                     #max_co_ef = max(co_ef),
                     median_pm_ef = round(median(pm_ef, na.rm = TRUE), 2),
                     q1_pm_ef = round(quantile(pm_ef, 0.25, na.rm = TRUE), 2),
                     q3_pm_ef = round(quantile(pm_ef, 0.75, na.rm = TRUE), 2),
                     median_co_ef = round(median(co_ef, na.rm = TRUE), 0),
                     q1_co_ef = round(quantile(co_ef, 0.25, na.rm = TRUE), 0),
                     q3_co_ef = round(quantile(co_ef, 0.75, na.rm = TRUE), 0)) %>%
    #dplyr::mutate(range_pm_ef = max_pm_ef - min_pm_ef,
    #              range_co_ef = max_co_ef - min_co_ef) %>%
    knitr::kable()
```

## Batch-fed stoves

```{r}
  batch %>%
    dplyr::group_by(stove) %>%
    dplyr::summarise(#min_pm_ef = min(pm_ef),
                     #max_pm_ef = max(pm_ef),
                     #min_co_ef = min(co_ef),
                     #max_co_ef = max(co_ef),
                     median_pm_ef = round(median(pm_ef, na.rm = TRUE), 2),
                     q1_pm_ef = round(quantile(pm_ef, 0.25, na.rm = TRUE), 2),
                     q3_pm_ef = round(quantile(pm_ef, 0.75, na.rm = TRUE), 2),
                     median_co_ef = round(median(co_ef, na.rm = TRUE), 0),
                     q1_co_ef = round(quantile(co_ef, 0.25, na.rm = TRUE), 0),
                     q3_co_ef = round(quantile(co_ef, 0.75, na.rm = TRUE), 0)) %>%
    #dplyr::mutate(range_pm_ef = max_pm_ef - min_pm_ef,
    #              range_co_ef = max_co_ef - min_co_ef) %>%
    knitr::kable()
```

# Statistics by fuel type

* Only looking at stoves tested with both fuels were selected

## Continuous-feed wood stoves

```{r}
  continuous %>%
    dplyr::group_by(fuel) %>%
    dplyr::filter(!grepl("plancha", stove), !grepl("21", id)) %>%
    dplyr::summarise(#min_pm_ef = min(pm_ef),
                     #max_pm_ef = max(pm_ef),
                     #min_co_ef = min(co_ef),
                     #max_co_ef = max(co_ef),
                     median_pm_ef = round(median(pm_ef, na.rm = TRUE), 2),
                     q1_pm_ef = round(quantile(pm_ef, 0.25, na.rm = TRUE), 2),
                     q3_pm_ef = round(quantile(pm_ef, 0.75, na.rm = TRUE), 2),
                     median_co_ef = round(median(co_ef, na.rm = TRUE), 0),
                     q1_co_ef = round(quantile(co_ef, 0.25, na.rm = TRUE), 0),
                     q3_co_ef = round(quantile(co_ef, 0.75, na.rm = TRUE), 0)) %>%
    #dplyr::mutate(range_pm_ef = max_pm_ef - min_pm_ef,
    #              range_co_ef = max_co_ef - min_co_ef) %>%
    knitr::kable()
```

## Batch-fed stoves

```{r}
  batch %>%
    dplyr::group_by(fuel) %>%
    dplyr::filter(grepl("8|9|10|11|22|24", id)) %>%
    dplyr::summarise(#min_pm_ef = min(pm_ef, na.rm = TRUE),
                     #max_pm_ef = max(pm_ef, na.rm = TRUE),
                     #min_co_ef = min(co_ef, na.rm = TRUE),
                     #max_co_ef = max(co_ef, na.rm = TRUE),
                     median_pm_ef = round(median(pm_ef, na.rm = TRUE), 2),
                     q1_pm_ef = round(quantile(pm_ef, 0.25, na.rm = TRUE), 2),
                     q3_pm_ef = round(quantile(pm_ef, 0.75, na.rm = TRUE), 2),
                     median_co_ef = round(median(co_ef, na.rm = TRUE), 0),
                     q1_co_ef = round(quantile(co_ef, 0.25, na.rm = TRUE), 0),
                     q3_co_ef = round(quantile(co_ef, 0.75, na.rm = TRUE), 0)) %>%
    #dplyr::mutate(range_pm_ef = max_pm_ef - min_pm_ef,
    #              range_co_ef = max_co_ef - min_co_ef) %>%
    knitr::kable()
```

# Statistics by test phase

## Continuous-feed wood stoves

```{r}
  continuous %>%
    dplyr::group_by(phase) %>%
    dplyr::summarise(#min_pm_ef = min(pm_ef),
                     #max_pm_ef = max(pm_ef),
                     #min_co_ef = min(co_ef),
                     #max_co_ef = max(co_ef),
                     median_pm_ef = round(median(pm_ef, na.rm = TRUE), 2),
                     q1_pm_ef = round(quantile(pm_ef, 0.25, na.rm = TRUE), 2),
                     q3_pm_ef = round(quantile(pm_ef, 0.75, na.rm = TRUE), 2),
                     median_co_ef = round(median(co_ef, na.rm = TRUE), 0),
                     q1_co_ef = round(quantile(co_ef, 0.25, na.rm = TRUE), 0),
                     q3_co_ef = round(quantile(co_ef, 0.75, na.rm = TRUE), 0)) %>%
    #dplyr::mutate(range_pm_ef = max_pm_ef - min_pm_ef,
    #              range_co_ef = max_co_ef - min_co_ef) %>%
    knitr::kable()
```

## Batch-fed charcoal stoves

```{r}
  batch_charcoal %>%
    dplyr::group_by(phase) %>%
    dplyr::summarise(#min_pm_ef = min(pm_ef),
                     #max_pm_ef = max(pm_ef),
                     #min_co_ef = min(co_ef),
                     #max_co_ef = max(co_ef),
                     median_pm_ef = round(median(pm_ef, na.rm = TRUE), 2),
                     q1_pm_ef = round(quantile(pm_ef, 0.25, na.rm = TRUE), 2),
                     q3_pm_ef = round(quantile(pm_ef, 0.75, na.rm = TRUE), 2),
                     median_co_ef = round(median(co_ef, na.rm = TRUE), 0),
                     q1_co_ef = round(quantile(co_ef, 0.25, na.rm = TRUE), 0),
                     q3_co_ef = round(quantile(co_ef, 0.75, na.rm = TRUE), 0)) %>%
    #dplyr::mutate(range_pm_ef = max_pm_ef - min_pm_ef,
    #              range_co_ef = max_co_ef - min_co_ef) %>%
    knitr::kable()
```

## Batch-fed wood stoves

```{r}
  batch_gasifier %>%
    dplyr::group_by(phase) %>%
    dplyr::summarise(#min_pm_ef = min(pm_ef),
                     #max_pm_ef = max(pm_ef),
                     #min_co_ef = min(co_ef),
                     #max_co_ef = max(co_ef),
                     median_pm_ef = round(median(pm_ef, na.rm = TRUE), 2),
                     q1_pm_ef = round(quantile(pm_ef, 0.25, na.rm = TRUE), 2),
                     q3_pm_ef = round(quantile(pm_ef, 0.75, na.rm = TRUE), 2),
                     median_co_ef = round(median(co_ef, na.rm = TRUE), 0),
                     q1_co_ef = round(quantile(co_ef, 0.25, na.rm = TRUE), 0),
                     q3_co_ef = round(quantile(co_ef, 0.75, na.rm = TRUE), 0)) %>%
    #dplyr::mutate(range_pm_ef = max_pm_ef - min_pm_ef,
    #              range_co_ef = max_co_ef - min_co_ef) %>%
    knitr::kable()
```