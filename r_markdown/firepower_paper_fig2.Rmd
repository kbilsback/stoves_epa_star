---
title: "Figure 2 for Firepower Sweep Paper"
output:
  html_document:
    toc: true
    toc_float: true
    theme: paper
---

```{r load_libraries, echo=FALSE, message=FALSE}
  if (!require("pacman")) install.packages("pacman")
  pacman::p_load(tidyverse, patchwork)
```

```{r global_options, include=FALSE}
  knitr::opts_chunk$set(fig.path='figures/', warning=FALSE, message=FALSE, cache=FALSE, echo=FALSE)
```

```{r load_data}
  grav <- readRDS("../r_files/lab_grav_merged.RDS")
  wbt <- readRDS("../r_files/wbt_data_merged.RDS")
```

```{r}
  source("../r_scripts/functions.r")
```

```{r}
  grav <-
    grav %>%
    dplyr::filter(id != "3B", fuel != "okote")
```

```{r}
  continuous <- 
    grav %>%
    dplyr::filter(grepl("fp|mce", var), grepl("continuous", fst_type)) %>%
    dplyr::select(-units) %>%
    tidyr::spread(var, val) %>%
    dplyr::mutate(phase = as.character(sample_id),
                  phase = ifelse(grepl("start_up", sample_id), "Start-up", phase),
                  phase = ifelse(grepl("shutdown", sample_id), "Shut-down", phase),
                  phase = ifelse(grepl("1|2|3|4", sample_id), "Sweep-down", phase),
                  phase = ifelse(grepl("5|6|7", sample_id), "Sweep-up", phase),
                  phase = forcats::fct_expand(as_factor(phase), "WBT: High power", "WBT: Low power"),
                  phase = as_factor(phase,
                                    levels = c("Start-up",
                                               "Sweep-down",
                                               "Sweep-up",
                                               "Shut-down",
                                               "WBT: High power",
                                               "WBT: Low power"),
                                    ordered = TRUE),
                  stove = forcats::fct_relevel(stove,
                                               "Three-stone fire",
                                               "Mud chulha",
                                               "Metal grill",
                                               "Rocket elbow",
                                               "Ceramic plancha",
                                               "Metal plancha"),
                  phase = forcats::fct_relevel(phase,
                                               "Start-up",
                                               "Sweep-down",
                                               "Sweep-up",
                                               "Shut-down",
                                               "WBT: High power",
                                               "WBT: Low power"))
```

```{r}
  batch <- 
    grav %>%
    dplyr::filter(grepl("fp|mce", var), grepl("batch", fst_type)) %>%
    dplyr::select(-units) %>%
    tidyr::spread(var, val) %>%
    dplyr::mutate(phase = as.character(sample_id),
                  phase = ifelse(grepl("start_up", sample_id), "Start-up", phase),
                  phase = ifelse(grepl("shutdown", sample_id), "Shut-down", phase),
                  phase = ifelse(grepl("3", sample_id), "Refuel", phase),
                  phase = ifelse(grepl("1|2", sample_id), "Pre-refuel", phase),
                  phase = ifelse(grepl("4|5", sample_id), "Post-refuel", phase))
```

```{r}
  wbt_plot <-
    wbt %>%
    dplyr::filter(grepl("firepower", pol)) %>%
    dplyr::mutate(value = ifelse(units == "watts", value / 1000, value)) %>%
    tidyr::spread(var, value) %>%
    dplyr::mutate(fp_min = mean - stdev, fp_max = mean + stdev) %>%
    dplyr::rename("firepower" = "mean") %>%
    dplyr::select(-stdev, -pol, -units) %>%
    dplyr::left_join(wbt %>%
                     dplyr::select(id, stove, fuel, pol, var, value,
                                   fuel_notes, protocol, protocol_notes) %>%
                     dplyr::filter(grepl("mce", pol)) %>%
                     tidyr::spread(var, value) %>%
                     dplyr::mutate(mce_min = mean - stdev, mce_max = mean + stdev) %>%
                     dplyr::rename("mce" = "mean") %>%
                     dplyr::select(-stdev, -pol),
                     by = c("id", "protocol", "stove", "fuel", "fuel_notes", "protocol_notes")) %>%
    dplyr::filter(fuel_notes != "wet", grepl("Three|Metal jiko|Rocket|Forced|plancha|Ceramic jiko", stove)) %>%
    dplyr::mutate(phase = ifelse(grepl("simmer", protocol), "WBT: Low power", "WBT: High power"))
```

```{r, eval=FALSE}
  eqn1 <- by(continuous, continuous$stove, fp_sum)
  eqn1 <- data.frame(eq = unclass(eqn1), stove = names(eqn1)) %>%
          dplyr::filter(!is.na(eq))
  eqn2 <- by(continuous, continuous$stove, mce_sum)
  eqn2 <- data.frame(eq = unclass(eqn2), stove = names(eqn2)) %>%
          dplyr::filter(!is.na(eq))
```

```{r, eval=FALSE}
  eqn3 <- by(batch, batch$stove, fp_sum)
  eqn3 <- data.frame(eq = unclass(eqn3), stove = names(eqn3)) %>%
          dplyr::filter(!is.na(eq))
  eqn4 <- by(batch, batch$stove, mce_sum)
  eqn4 <- data.frame(eq = unclass(eqn4), stove = names(eqn4)) %>%
          dplyr::filter(!is.na(eq))
```

```{r}
  wbt_cont <-
    wbt_plot %>%
    dplyr::filter(grepl("continuous", fst_type), !is.na(firepower)) %>%
    dplyr::rename("fp" = "firepower") %>%
    dplyr::mutate(fuel = "")

  continuous <- 
    continuous %>%
    bind_rows(wbt_cont) %>%
    dplyr::mutate(phase = forcats::fct_expand(as_factor(phase),
                                              "Start-up",
                                              "Sweep-down",
                                              "Sweep-up",
                                              "Shut-down",
                                              "WBT: High power",
                                              "WBT: Low power"),
                  phase = forcats::fct_relevel(phase,
                                               "Start-up",
                                               "Sweep-down",
                                               "Sweep-up",
                                               "Shut-down",
                                               "WBT: High power",
                                               "WBT: Low power"),
                  stove = forcats::fct_relevel(stove,
                                               "Three-stone fire",
                                               "Mud chulha",
                                               "Metal grill",
                                               "Rocket elbow",
                                               "Ceramic plancha",
                                               "Metal plancha"))
    

  wbt_batch <-
    wbt_plot %>%
    dplyr::filter(grepl("batch", fst_type)) %>%
        dplyr::rename("fp" = "firepower") %>%
    dplyr::mutate(fuel = "")
  
  batch <-
    batch %>%
    bind_rows(wbt_batch) %>%
    dplyr::mutate(phase = forcats::fct_expand(as_factor(phase),
                                               "Start-up",
                                               "Pre-refuel",
                                               "Refuel",
                                               "Post-refuel",
                                               "Shut-down",
                                               "WBT: High power",
                                               "WBT: Low power"),
                  phase = forcats::fct_relevel(phase,
                                               "Start-up",
                                               "Pre-refuel",
                                               "Refuel",
                                               "Post-refuel",
                                               "Shut-down",
                                               "WBT: High power",
                                               "WBT: Low power"),
                  stove = forcats::fct_relevel(stove,
                                               "Ceramic jiko",
                                               "Metal jiko",
                                               "Forced-draft gasifier"),
                  fuel = forcats::fct_relevel(fuel,
                                              "Coconut (briquettes)",
                                              "Hardwood (lumps)",
                                              "Eucalyptus (pellets)",
                                              "Red oak (milled)"))
```

# Plots

```{r}
  p1 <-
    continuous %>%
      ggplot(aes(x = fp, y = mce)) +
        geom_point(aes(shape = phase, color = fuel), size = 3, alpha = 0.75, stroke = 1) +
        # geom_text(data = eqn1, aes(x = 10, y = 0.825, label = eq),
        #           color = "black",  parse = TRUE, size = 4) +
        # geom_text(data = eqn2, aes(x = 9, y = 0.80, label = eq),
        #           color = "black",  parse = TRUE, size = 4) +
        geom_errorbar(aes(ymin = mce_min, ymax = mce_max),
                      width = 0, color = "black") +
        geom_errorbarh(aes(xmin = fp_min, xmax = fp_max),
                       height = 0, color = "black") +
        scale_color_manual(values = c("black", "#999999", "#E69F00")) +
        guides(color = guide_legend(override.aes = list(size = 3,
                                                        color = c("#FFFFFF", "#999999", "#E69F00")))) +
        scale_shape_manual(values = c(8, 1, 16, 4, 0, 2)) +
        theme_bw() + 
        theme(text = element_text(size = 20),
              strip.background = element_rect(fill = "white"),
              plot.title = element_text(hjust = 0.5),
              legend.position = "right") +
          facet_wrap(~ stove, nrow = 2) +
          ggtitle("Continuous-Feed Wood Stoves") +
          scale_x_continuous(breaks = c(0, 4, 8, 12, 16), limits = c(0, 14)) +
          xlab("Firepower (kW)") +
          ylab("MCE") +
          labs(shape = "", color = "")
```

```{r}
  p2 <-
    batch %>%
      ggplot(aes(x = fp, y = mce)) +
        geom_point(aes(shape = phase, color = fuel), size = 3, alpha = 0.75, stroke = 1) +
        # geom_text(data = eqn3, aes(x = 5.75, y = 0.70, label = eq),
        #           color = "black",  parse = TRUE, size = 4) +
        # geom_text(data = eqn4, aes(x = 5, y = 0.665, label = eq),
        #           color = "black",  parse = TRUE, size = 4) +
        geom_errorbar(aes(ymin = mce_min, ymax = mce_max),
                      width = 0, color = "black") +
        geom_errorbarh(aes(xmin = fp_min, xmax = fp_max),
                       height = 0, color = "black") +
        scale_color_manual(values = c("yellowgreen", "darkcyan", "coral3", "#0072B2", "black")) +
        guides(color = guide_legend(override.aes = list(size = 3,
                                                        color = c("yellowgreen", "darkcyan",
                                                                  "coral3", "#0072B2", "#FFFFFF")))) +
        scale_shape_manual(values = c(8, 1, 3, 16, 4, 0, 2)) +
        scale_y_continuous(breaks = c(0.70, 0.80, 0.90, 1.00), labels = c("0.70","0.80", "0.90", "1.00")) +
        theme_bw() + 
        theme(text = element_text(size = 20),
              strip.background = element_rect(fill = "white"),
              plot.title = element_text(hjust = 0.5),
              legend.position = "right") +
          facet_wrap(~stove, nrow = 1) +
          ggtitle("Batch-Fed Stoves") +
          xlab("Firepower (kW)") +
          ylab("MCE") +
          labs(color = "", shape = "")
```

```{r figure_2, echo=FALSE, fig.width=12, fig.height=11, dpi=600, dev='pdf'}
  p1 + p2 + plot_layout(ncol = 1, heights = c(2, 1))
```

# Statistics by test type

```{r}
  continuous <- 
    continuous %>%
    dplyr::filter(test_type != "WBT")

  batch <- 
    batch %>%
    dplyr::filter(test_type != "WBT")
```

```{r}
  batch_charcoal <- 
    batch %>%
    dplyr::filter(grepl("Coconut|Hardwood", fuel), test_type != "WBT")
```

```{r}
  batch_gasifier <- 
    batch %>%
    dplyr::filter(!grepl("Coconut|Hardwood", fuel), test_type != "WBT")
```

## Continuous-feed wood stoves

```{r}
  continuous %>%
    dplyr::summarise(#min_fp = min(fp, na.rm = TRUE),
                     #max_fp = max(fp, na.rm = TRUE),
                     #min_mce = min(mce, na.rm = TRUE),
                     #max_mce = max(mce, na.rm = TRUE),
                     median_fp = round(median(fp, na.rm = TRUE), 1),
                     q1_fp = round(quantile(fp, 0.25, na.rm = TRUE), 1),
                     q3_fp = round(quantile(fp, 0.75, na.rm = TRUE), 1),
                     median_mce = round(median(mce, na.rm = TRUE), 2),
                     q1_mce = round(quantile(mce, 0.25, na.rm = TRUE), 2),
                     q3_mce = round(quantile(mce, 0.75, na.rm = TRUE), 2)) %>%
    #dplyr::mutate(range_fp = max_fp - min_fp,
    #              range_mce = max_mce - min_mce) %>%
    knitr::kable()
```

## Batch-fed charcoal stoves

```{r}
  batch_charcoal %>%
    dplyr::summarise(#min_fp = min(fp, na.rm = TRUE),
                     #max_fp = max(fp, na.rm = TRUE),
                     #min_mce = min(mce, na.rm = TRUE),
                     #max_mce = max(mce, na.rm = TRUE),
                     median_fp = round(median(fp, na.rm = TRUE), 1),
                     q1_fp = round(quantile(fp, 0.25, na.rm = TRUE), 1),
                     q3_fp = round(quantile(fp, 0.75, na.rm = TRUE), 1),
                     median_mce = round(median(mce, na.rm = TRUE), 2),
                     q1_mce = round(quantile(mce, 0.25, na.rm = TRUE), 2),
                     q3_mce = round(quantile(mce, 0.75, na.rm = TRUE), 2)) %>%
    #dplyr::mutate(range_fp = max_fp - min_fp,
    #              range_mce = max_mce - min_mce) %>%
    knitr::kable()
```

## Batch-fed wood stoves

```{r}
  batch_gasifier %>%
    dplyr::summarise(#min_fp = min(fp, na.rm = TRUE),
                     #max_fp = max(fp, na.rm = TRUE),
                     #min_mce = min(mce, na.rm = TRUE),
                     #max_mce = max(mce, na.rm = TRUE),
                     median_fp = round(median(fp, na.rm = TRUE), 1),
                     q1_fp = round(quantile(fp, 0.25, na.rm = TRUE), 1),
                     q3_fp = round(quantile(fp, 0.75, na.rm = TRUE), 1),
                     median_mce = round(median(mce, na.rm = TRUE), 2),
                     q1_mce = round(quantile(mce, 0.25, na.rm = TRUE), 2),
                     q3_mce = round(quantile(mce, 0.75, na.rm = TRUE), 2)) %>%
    #dplyr::mutate(range_fp = max_fp - min_fp,
    #              range_mce = max_mce - min_mce) %>%
    knitr::kable()
```

# Statistics by stove type and stove category

## Continuous-feed wood stoves

```{r}
  continuous %>%
    dplyr::group_by(stove) %>%
    dplyr::summarise(#min_fp = min(fp, na.rm = TRUE),
                     #max_fp = max(fp, na.rm = TRUE),
                     #min_mce = min(mce, na.rm = TRUE),
                     #max_mce = max(mce, na.rm = TRUE),
                     median_fp = round(median(fp, na.rm = TRUE), 1),
                     q1_fp = round(quantile(fp, 0.25, na.rm = TRUE), 1),
                     q3_fp = round(quantile(fp, 0.75, na.rm = TRUE), 1),
                     median_mce = round(median(mce, na.rm = TRUE), 2),
                     q1_mce = round(quantile(mce, 0.25, na.rm = TRUE), 2),
                     q3_mce = round(quantile(mce, 0.75, na.rm = TRUE), 2)) %>%
    #dplyr::mutate(range_fp = max_fp - min_fp,
    #              range_mce = max_mce - min_mce) %>%
    knitr::kable()
```

```{r}
  continuous %>%
    dplyr::group_by(stove_cat) %>%
    dplyr::summarise(#min_fp = min(fp, na.rm = TRUE),
                     #max_fp = max(fp, na.rm = TRUE),
                     #min_mce = min(mce, na.rm = TRUE),
                     #max_mce = max(mce, na.rm = TRUE),
                     median_fp = round(median(fp, na.rm = TRUE), 1),
                     q1_fp = round(quantile(fp, 0.25, na.rm = TRUE), 1),
                     q3_fp = round(quantile(fp, 0.75, na.rm = TRUE), 1),
                     median_mce = round(median(mce, na.rm = TRUE), 2),
                     q1_mce = round(quantile(mce, 0.25, na.rm = TRUE), 2),
                     q3_mce = round(quantile(mce, 0.75, na.rm = TRUE), 2)) %>%
    #dplyr::mutate(range_fp = max_fp - min_fp,
    #              range_mce = max_mce - min_mce) %>%
    knitr::kable()
```

## Batch-fed stoves

```{r}
  batch %>%
    dplyr::group_by(stove) %>%
    dplyr::summarise(#min_fp = min(fp, na.rm = TRUE),
                     #max_fp = max(fp, na.rm = TRUE),
                     #min_mce = min(mce, na.rm = TRUE),
                     #max_mce = max(mce, na.rm = TRUE),
                     median_fp = round(median(fp, na.rm = TRUE), 1),
                     q1_fp = round(quantile(fp, 0.25, na.rm = TRUE), 1),
                     q3_fp = round(quantile(fp, 0.75, na.rm = TRUE), 1),
                     median_mce = round(median(mce, na.rm = TRUE), 2),
                     q1_mce = round(quantile(mce, 0.25, na.rm = TRUE), 2),
                     q3_mce = round(quantile(mce, 0.75, na.rm = TRUE), 2)) %>%
    #dplyr::mutate(range_fp = max_fp - min_fp,
    #              range_mce = max_mce - min_mce) %>%
    knitr::kable()
```

# Statistics by fuel type

* Only looking at stoves tested with both fuels were selected

## Continuous-feed wood stoves

```{r}
  continuous %>%
    dplyr::group_by(fuel) %>%
    dplyr::filter(!grepl("plancha", stove), !grepl("21", id)) %>%
    dplyr::summarise(#min_fp = min(fp, na.rm = TRUE),
                     #max_fp = max(fp, na.rm = TRUE),
                     #min_mce = min(mce, na.rm = TRUE),
                     #max_mce = max(mce, na.rm = TRUE),
                     median_fp = round(median(fp, na.rm = TRUE), 1),
                     q1_fp = round(quantile(fp, 0.25, na.rm = TRUE), 1),
                     q3_fp = round(quantile(fp, 0.75, na.rm = TRUE), 1),
                     median_mce = round(median(mce, na.rm = TRUE), 2),
                     q1_mce = round(quantile(mce, 0.25, na.rm = TRUE), 2),
                     q3_mce = round(quantile(mce, 0.75, na.rm = TRUE), 2)) %>%
    #dplyr::mutate(range_fp = max_fp - min_fp,
    #              range_mce = max_mce - min_mce) %>%
    knitr::kable()
```

## Batch-fed stoves

```{r}
  batch %>%
    dplyr::group_by(fuel) %>%
    dplyr::filter(grepl("8|9|10|11|22|24", id)) %>%
    dplyr::summarise(#min_fp = min(fp, na.rm = TRUE),
                     #max_fp = max(fp, na.rm = TRUE),
                     #min_mce = min(mce, na.rm = TRUE),
                     #max_mce = max(mce, na.rm = TRUE),
                     median_fp = round(median(fp, na.rm = TRUE), 1),
                     q1_fp = round(quantile(fp, 0.25, na.rm = TRUE), 1),
                     q3_fp = round(quantile(fp, 0.75, na.rm = TRUE), 1),
                     median_mce = round(median(mce, na.rm = TRUE), 2),
                     q1_mce = round(quantile(mce, 0.25, na.rm = TRUE), 2),
                     q3_mce = round(quantile(mce, 0.75, na.rm = TRUE), 2)) %>%
    #dplyr::mutate(range_fp = max_fp - min_fp,
    #              range_mce = max_mce - min_mce) %>%
    knitr::kable()
```

# Statistics by test phase

## Continuous-feed wood stoves

```{r}
  continuous %>%
    dplyr::group_by(phase) %>%
    dplyr::summarise(#min_fp = min(fp, na.rm = TRUE),
                     #max_fp = max(fp, na.rm = TRUE),
                     #min_mce = min(mce, na.rm = TRUE),
                     #max_mce = max(mce, na.rm = TRUE),
                     median_fp = round(median(fp, na.rm = TRUE), 1),
                     q1_fp = round(quantile(fp, 0.25, na.rm = TRUE), 1),
                     q3_fp = round(quantile(fp, 0.75, na.rm = TRUE), 1),
                     median_mce = round(median(mce, na.rm = TRUE), 2),
                     q1_mce = round(quantile(mce, 0.25, na.rm = TRUE), 2),
                     q3_mce = round(quantile(mce, 0.75, na.rm = TRUE), 2)) %>%
    #dplyr::mutate(range_fp = max_fp - min_fp,
    #              range_mce = max_mce - min_mce) %>%
    knitr::kable()
```

## Batch-fed charcoal stoves

```{r}
  batch_charcoal %>%
    dplyr::group_by(phase) %>%
    dplyr::summarise(#min_fp = min(fp, na.rm = TRUE),
                     #max_fp = max(fp, na.rm = TRUE),
                     #min_mce = min(mce, na.rm = TRUE),
                     #max_mce = max(mce, na.rm = TRUE),
                     median_fp = round(median(fp, na.rm = TRUE), 1),
                     q1_fp = round(quantile(fp, 0.25, na.rm = TRUE), 1),
                     q3_fp = round(quantile(fp, 0.75, na.rm = TRUE), 1),
                     median_mce = round(median(mce, na.rm = TRUE), 2),
                     q1_mce = round(quantile(mce, 0.25, na.rm = TRUE), 2),
                     q3_mce = round(quantile(mce, 0.75, na.rm = TRUE), 2)) %>%
    #dplyr::mutate(range_fp = max_fp - min_fp,
    #              range_mce = max_mce - min_mce) %>%
    knitr::kable()
```

## Batch-fed wood stoves

```{r}
  batch_gasifier %>%
    dplyr::group_by(phase) %>%
    dplyr::summarise(#min_fp = min(fp, na.rm = TRUE),
                     #max_fp = max(fp, na.rm = TRUE),
                     #min_mce = min(mce, na.rm = TRUE),
                     #max_mce = max(mce, na.rm = TRUE),
                     median_fp = round(median(fp, na.rm = TRUE), 1),
                     q1_fp = round(quantile(fp, 0.25, na.rm = TRUE), 1),
                     q3_fp = round(quantile(fp, 0.75, na.rm = TRUE), 1),
                     median_mce = round(median(mce, na.rm = TRUE), 2),
                     q1_mce = round(quantile(mce, 0.25, na.rm = TRUE), 2),
                     q3_mce = round(quantile(mce, 0.75, na.rm = TRUE), 2)) %>%
    #dplyr::mutate(range_fp = max_fp - min_fp,
    #              range_mce = max_mce - min_mce) %>%
    knitr::kable()
```