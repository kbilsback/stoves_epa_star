---
title: "Lab inamodel"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r load_libraries, echo=FALSE}
  library(mfp)      # transformation analysis
  #library(glmulti)  # interaction analysis
  library(tidyverse)
  library(knitr)
  library(MASS)
  library(lmtest)
  library(lme4)
  library(effects)
  library(leaps)
  library(rms) 
  library(arm)
```

```{r global_options, include=FALSE}
  knitr::opts_chunk$set(fig.path='figures/', warning=FALSE, message=FALSE, cache=FALSE)
```

# Load files

* data

```{r load_data, echo=FALSE}
  lab_grav <- readRDS("../r_files/lab_grav_merged.RDS")
```

* functions

```{r load_functions, echo=FALSE}
  source("../r_scripts/lab_model_metrics.R")
  source("../r_scripts/functions.R")
```

* metadata

```{r load_meta, echo=FALSE}
  lab_samples <- readRDS("../r_files/lab_meta.RDS")
```

# Tidy data

## Lab data

* select bc emissions rate as the outcome
* select only wood tests
* filter out Okote tests

```{r, echo=FALSE}
  lab_data <- lab_grav %>%
              dplyr::select(-units) %>%
              tidyr::spread(var, val) %>% 
              dplyr::select(id, sample_id, bc_rate, fp, mce) %>%
              dplyr::left_join(lab_samples, by = "id") %>%
              #dplyr::filter(sample_id != "start_up", sample_id != "shutdown") %>% 
              dplyr::filter(fuel != "Okote") %>%
              dplyr::filter(fuel_type == "wood") %>%
              dplyr::filter(!is.na(bc_rate), !is.na(fp), !is.na(mce))
```

# Reference models

## Basic model

* start by setting up a model that regresses firpower to bc emissions rate for all lab data

```{r basic_model, results='hide'}
# Basic linear firepower model
  eqn <- formula(bc_rate ~ 1 + fp)
  basic_fp <- glm(eqn, data = lab_data)
  basic_coef <- coef(basic_fp)
  rmse <- rmse_id_avg(basic_fp, lab_data)
  basic_rmse_lpm <- mean(rmse$rmse_lpm)
  basic_rmse_pct <- mean(rmse$rmse_pct)
  summary(basic_fp)
  plot(basic_fp)
```

The resulting linear model is: $$V_{e} = `r round(basic_coef[2], digits = 3)` \times H_{r} `r round(basic_coef[1], digits = 3)`$$ with an *rmse* of `r round(basic_rmse_lpm, digits = 1)` L/min and `r round(basic_rmse_pct, digits = 1)`%. We can test the predictive ability of the model using leave-one-out cross validation.
