---
title: "Build lab model"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r load_libraries, echo=FALSE, message=FALSE}
  library(mfp)      # transformation analysis
  #library(glmulti)  # interaction analysis
  library(tidyverse)
  library(knitr)
  library(MASS)
  library(lmtest)
  library(lme4)
  library(effects)
  library(leaps)
  library(rms) 
  library(arm)
```

```{r global_options, include=FALSE}
  knitr::opts_chunk$set(fig.path='figures/', warning=FALSE, message=FALSE, cache=FALSE)
```

# Organize lab data

## Load files

* data

```{r load_data}
  lab_grav <- readRDS("../r_files/lab_grav_merged.RDS")
```

* functions

```{r load_functions}
  source("../r_scripts/lab_model_metrics.R")
  source("../r_scripts/functions.R")
```

* metadata

```{r load_meta}
  lab_samples <- readRDS("../r_files/lab_meta.RDS")
```

## Tidy data

* select bc emissions rate as outcome
* merge with metadata
* select only wood tests
* filter out Okote tests

```{r}
  lab_data <- lab_grav %>%
              dplyr::select(-units) %>%
              tidyr::spread(var, val) %>% 
              dplyr::select(id, sample_id, bc_rate, fp, mce) %>%
              dplyr::left_join(lab_samples, by = "id") %>%
              #dplyr::filter(sample_id != "start_up", sample_id != "shutdown") %>% 
              dplyr::filter(fuel != "Okote") %>%
              dplyr::filter(fuel_type == "wood") %>%
              dplyr::filter(!is.na(bc_rate), !is.na(fp), !is.na(mce))
```

# Reference models

## Basic model

* start by setting up a model that regresses firpower to bc emissions rate for all lab data

```{r basic_model, results='hide'}
# Build basic linear firepower model
  eqn <- formula(bc_rate ~ 1 + fp)
  basic_fp <- glm(eqn, data = lab_data)
  basic_coef <- coef(basic_fp)
  rmse <- rmse_id_avg(basic_fp, lab_data)
  basic_rmse <- mean(rmse$rmse)
  summary(basic_fp)
  plot(basic_fp)
```

The resulting linear model is: $$\text{BC rate} = `r round(basic_coef[2], digits = 3)` \times FP `r round(basic_coef[1], digits = 3)`$$ with an *rmse* of `r round(basic_rmse, digits = 1)` miligrams per minute. We can test the predictive ability of the model using leave-one-out cross validation.

```{r, echo=TRUE}
  rmse <- leave_one_out(eqn, lab_data) # leave one out cross validation
```

The predictive ability of the basic model can be tested using a *leave-one-out* validation. The mean rmse when prediciting each participant was: `r round(mean(rmse$rmse_lpm), digits = 2)` mg/min (s.d. = `r round(sd(rmse$rmse_lpm), digits = 2)`).

```{r, echo=TRUE, message=FALSE, warning=FALSE, tidy=TRUE, results='hide', cache=TRUE}
# histogram of predictions from basic model
  ggplot(rmse, aes(x=rmse)) + geom_histogram() + 
    ggtitle("RMSE of each participant's predictions - basic model ") +
    xlab("RMSE (L/min)") +
    ylab("n") +
    theme_classic()
```