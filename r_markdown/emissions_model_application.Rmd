---
title: "Part 3: Predicting emissions with firepower"
output:
  html_document:
    toc: true
    toc_float: true
    theme: paper
---

```{r load_libraries, echo=FALSE, message=FALSE}
  if (!require("pacman")) install.packages("pacman")
  pacman::p_load(tidyverse, knitr, patchwork, kableExtra)
  options(knitr.table.format = "latex")
```

```{r, echo=FALSE, message=FALSE}
  library(tidyverse)
  library(mvtnorm)
```

```{r global_options, include=FALSE}
  knitr::opts_chunk$set(fig.path = 'figures/', warning = FALSE,
                        message = FALSE, cache = FALSE)
```

```{r, echo=FALSE}
  fp_boot <- readRDS("../r_files/fp_scale.RDS")
  wood_pm <- readRDS("../r_files/wood_pm_mod.RDS")
  wood_scale <- readRDS("../r_files/wood_scale.RDS")
  wood_co <- readRDS("../r_files/wood_co_mod.RDS")
  wood_bc <- readRDS("../r_files/wood_bc_mod.RDS")
  field_emissions <- readRDS("../r_files/rose_field_data2.RDS")
```

# Summarize models to be used

* These models were built with scaled data should I use the mean and standard deviation from the original data set to scale the data I am trying to use to predict emissions? - Do this for now.
* Should I be using a different scale for each stove?

```{r, echo=FALSE}
  summary(wood_pm)
```

```{r, echo=FALSE}
  summary(wood_co)
```

```{r, echo=FALSE}
  summary(wood_bc)
```

# Estimate emissions using model

Scale data and change variable names

* Need to decide which type of wood to use in the model
* One option would be to make a new models with wood as a random effect?

```{r, echo=FALSE}
  fp_boot <-
    fp_boot %>%
    dplyr::ungroup() %>%
    dplyr::rename(fp = val, stove_fuel = stove) %>%
    dplyr::mutate(stove_fuel = gsub("$", " Douglas fir (milled)", stove_fuel)) %>%
    dplyr::mutate(fp = (fp - wood_scale$mean) / wood_scale$sd)
```

## PM2.5

Predict emissions

```{r}
  emissions_pm <- predict(wood_pm, fp_boot, interval = "predict")
```

Organize data for plotting

```{r}
  emissions_pm <-  as.data.frame(emissions_pm)

  emissions_pm <-
    emissions_pm %>%
    dplyr::bind_cols(dplyr::select(fp_boot, hh_id, stove_fuel, datetime)) %>%
    dplyr::rename(pm = fit) %>%
    dplyr::select(-lwr, -upr)
```

## CO

Predict emissions

```{r}
  emissions_co <- predict(wood_co, fp_boot, interval = "predict")
```

Organize data for plotting

```{r}
  emissions_co <-  as.data.frame(emissions_co)

  emissions_co <-
    emissions_co %>%
    dplyr::bind_cols(dplyr::select(fp_boot, hh_id, stove_fuel, datetime)) %>%
    dplyr::rename(co = fit) %>%
    dplyr::select(-lwr, -upr)
```

## BC

Predict emissions

```{r}
  emissions_bc <- predict(wood_bc, fp_boot, interval = "predict")
```

Organize data for plotting

```{r}
  emissions_bc <-  as.data.frame(emissions_bc)

  emissions_bc <-
    emissions_bc %>%
    dplyr::bind_cols(dplyr::select(fp_boot, hh_id, stove_fuel, datetime)) %>%
    dplyr::rename(bc = fit) %>%
    dplyr::select(-lwr, -upr)
```

# Compare predictions to actual data

Not sure which is the best way to average (use Type 2)

## PM2.5 data

* Exponentiate the data
* Group by temperature observation find the mean, then group by the cooking event and find the mean and standard deviation

```{r}
  emissions_sum <-
    emissions_pm %>%
    #dplyr::mutate(pm = exp(pm)) %>%
    dplyr::group_by(hh_id, stove_fuel, datetime) %>%
    dplyr::summarise(pm = mean(pm)) %>%
    dplyr::ungroup() %>%
    dplyr::group_by(hh_id, stove_fuel) %>%
    dplyr::summarise(mean = mean(pm),
                     sd = sd(pm))
```

Plot of estimated PM2.5 emissions (colored) and actual PM2.5 emissions (black)

```{r, echo=FALSE}
  emissions_sum %>%
    dplyr::left_join(field_emissions, by = c("hh_id" = "id")) %>%
    ggplot(aes(x = hh_id, y = mean, color = hh_id)) +
    geom_point(size = 3) +
    geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd)) +
    geom_point(aes(x = hh_id, y = pm_ef), shape = 8, color = "black", size = 3) +
    theme_minimal() +
    theme(legend.position = "none") +
    xlab("") +
    ylab("pm estimate")
```

## CO data

* Exponentiate the data
* Group by temperature observation find the mean, then group by the cooking event and find the mean and standard deviation

```{r}
  emissions_sum2 <-
    emissions_co %>%
    dplyr::mutate(co = exp(co)) %>%
    dplyr::group_by(hh_id, stove_fuel, datetime) %>%
    dplyr::summarise(co = mean(co)) %>%
    dplyr::ungroup() %>%
    dplyr::group_by(hh_id, stove_fuel) %>%
    dplyr::summarise(mean = mean(co),
                     sd = sd(co))
```

Plot of estimated CO emissions (colored) and actual CO emissions (black)

```{r, echo=FALSE}
  emissions_sum2 %>%
    dplyr::left_join(field_emissions, by = c("hh_id" = "id")) %>%
    ggplot(aes(x = hh_id, y = mean, color = hh_id)) +
    geom_point(size = 3) +
    geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd)) +
    geom_point(aes(x = hh_id, y = co_ef), shape = 8, color = "black", size = 3) +
    theme_minimal() +
    theme(legend.position = "none") +
    xlab("") +
    ylab("co estimate")
```

## BC data

* Exponentiate the data
* Group by temperature observation find the mean, then group by the cooking event and find the mean and standard deviation

```{r}
  emissions_sum2 <-
    emissions_bc %>%
    dplyr::mutate(bc = exp(bc)) %>%
    dplyr::group_by(hh_id, stove_fuel, datetime) %>%
    dplyr::summarise(bc = mean(bc)) %>%
    dplyr::ungroup() %>%
    dplyr::group_by(hh_id, stove_fuel) %>%
    dplyr::summarise(mean = mean(bc),
                     sd = sd(bc))
```

Plot of estimated BC emissions (colored) and actual BC emissions (black)

```{r, echo=FALSE}
  emissions_sum2 %>%
    dplyr::left_join(field_emissions, by = c("hh_id" = "id")) %>%
    ggplot(aes(x = hh_id, y = mean, color = hh_id)) +
    geom_point(size = 3) +
    geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd)) +
    geom_point(aes(x = hh_id, y = bc_ef), shape = 8, color = "black", size = 3) +
    theme_minimal() +
    theme(legend.position = "none") +
    xlab("") +
    ylab("bc estimate")
```

