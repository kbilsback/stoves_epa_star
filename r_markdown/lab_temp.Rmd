---
title: "Lab temperature processing"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r load_libraries, echo=FALSE, message=FALSE}
  if (!require("pacman")) install.packages("pacman")
  pacman::p_load(tidyverse, hms)
```

```{r global_options, include=FALSE}
  knitr::opts_chunk$set(fig.path='figures/', warning=FALSE, message=FALSE, cache=FALSE, echo=FALSE)
```

```{r functions}
  source("../r_scripts/functions.R")
```

```{r}
  times <- readRDS("../r_files/lab_segments.RDS")
  temp_a <- readRDS("../r_files/lab_temp_a.RDS")
  temp_b <- readRDS("../r_files/lab_temp_b.RDS")
  samples <- readRDS("../r_files/lab_samples.RDS")
```

```{r}
  times <-
    times %>%
    dplyr::left_join(dplyr::select(samples, id, fst_type), by = c("test_id" = "id")) %>%
    dplyr::mutate(sample_id = gsub(".*[a-z]", "fp", var),
                  var = gsub("_[0-9]", "", var)) %>%
    tidyr::spread("var", "val")
```

```{r}
  temp_b <-
    temp_b %>%
    dplyr::mutate(datetime = as.POSIXct(datetime, "MST", 
                                        format = "%m/%d/%y %H:%M"),
                  date = as.Date(datetime),
                  time = as.numeric(as.hms(datetime)))
```

```{r}
  temp_merged <- filter_times2(times, temp_a)
  temp_merged2 <- filter_times3(times, temp_b)

  temp_merged <- 
    temp_merged %>%
    dplyr::bind_rows(temp_merged2) %>%
    dplyr::filter(water_temp <= 400, water_temp > 10)
```

```{r, fig.height=20, fig.width=12}
  ggplot(temp_merged, aes(x = time, y = water_temp, color = sample_id)) +
         geom_point() +
         theme_bw() +
         facet_wrap(~test_id, scales = "free_x") +
         theme(legend.position = "top") +
         ylab("degress Kelvin")
```

```{r}
  temp_summarize <- 
    temp_merged %>%
    dplyr::group_by(test_id, sample_id) %>%
    dplyr::summarise(t_min = quantile(water_temp, 0.025, na.rm = TRUE),
                     t_max = quantile(water_temp, 0.99, na.rm = TRUE),
                     delta_t = t_max - t_min)
```

```{r, fig.height=20, fig.width=12}
  ggplot(temp_summarize, aes(x = sample_id, y = delta_t, color = sample_id)) +
    geom_point() +
    theme_bw() +
    facet_wrap(~test_id, scales = "free") +
    theme(legend.position = "top") +
    ylab("degress Kelvin")
```

```{r}
  saveRDS(temp_summarize, "../r_files/lab_temp_summary.RDS")
```
