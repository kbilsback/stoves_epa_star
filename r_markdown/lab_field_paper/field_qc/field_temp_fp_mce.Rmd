---
title: "Figure 2 - MCE vs Firepower"
output:
  word_document:
    toc: yes
---

```{r load_libraries, echo=FALSE, message=FALSE}
  if (!require("pacman")) install.packages("pacman")
  pacman::p_load(tidyverse, patchwork, weathermetrics, lmerTest,
                 lme4, MuMIn, merTools, Matrix, mvtnorm, matrixcalc)
  options(knitr.table.format = "latex")
```

```{r global_options, include=FALSE}
  knitr::opts_chunk$set(fig.path = 'figures/', warning = FALSE,
                        message = FALSE, cache = FALSE)
```

# Import data

Import emissions event temperature data

```{r}
  india <- readRDS("../../r_files/india_temp_merged.RDS")
  honduras <- readRDS("../../r_files/honduras_temp_merged.RDS")
  uganda <- readRDS("../../r_files/uganda_temp_merged.RDS")

  field_temp_event <-
    india %>%
    dplyr::bind_rows(honduras) %>%
    dplyr::bind_rows(uganda)
```

Import field firepower and lab firepower

```{r}
  field_fp <- readRDS("../../r_files/field_firepower.RDS")
  field_samples <- readRDS("../../r_files/field_samples.RDS")
```

Import field mce data

```{r}
  field_mce <- readRDS("../../r_files/field_emissions_rt_data.RDS")
```

# Convert field-derived temperature data to firepower

Calculate average change in temperature in the field by household

```{r}
  field_temp_event_avg <-
    field_temp_event %>%
    dplyr::group_by(field_site, hh_id) %>%
    dplyr::summarise(temp_avg = mean(temp, na.rm = TRUE))
```

Calculate scaling factor for each household

* m = log(FP) / delta T

```{r}
  field_temp_fp_scale <-
    field_temp_event_avg %>%
    dplyr::left_join(field_fp, by = c("hh_id", "field_site")) %>%
    dplyr::mutate(scale_factor = fp / temp_avg) %>%
    dplyr::select(field_site, hh_id, scale_factor, lhv)
```

Estimate firepower using scaling factor

```{r}
  field_fp_est <-
    field_temp_event %>%
    dplyr::left_join(field_temp_fp_scale, by = c("hh_id", "field_site")) %>%
    dplyr::mutate(fp_est = temp * scale_factor) %>%
    dplyr::filter(!is.na(fp_est)) %>%
    dplyr::select(-time, -date, -time, -scale_factor)
```

# Merge with field firepower and MCE

* Remove erroneous mce data (greater than one or less than zero)
* Coerce into R data types

```{r}
  field_mce <-
    field_mce %>%
    dplyr::select(field_site, id, time, mce) %>%
    dplyr::rename("hh_id" = "id") %>%
    dplyr::filter(!(mce >= 1)) %>%
    dplyr::mutate(datetime = as.POSIXct(time, format = "%d-%b-%Y %H:%M:%S"),
                  datetime = lubridate::force_tz(datetime, "MST")) %>%
    dplyr::select(-time)
```

Merge with firepower data

```{r}
  field_fp_mce <-
    field_fp_est %>%
    dplyr::left_join(field_mce, by = c("field_site", "hh_id", "datetime")) %>%
    dplyr::group_by(datetime = cut(datetime, breaks = "3 min"), hh_id, field_site) %>%
    dplyr::summarise(firepower = mean(fp_est, na.rm = TRUE),
                     mce = mean(mce, na.rm = TRUE),
                     temp = mean(temp, na.rm = TRUE),
                     lhv = first(lhv)) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(datetime = as.POSIXct(datetime)) %>%
    dplyr::left_join(dplyr::select(field_samples, hh_id, stove_type), by = "hh_id") %>%
    dplyr::mutate(stove_type = ifelse(stove_type == "Mud chula", "Mud chulha", stove_type)) %>%
    na.omit %>%
    dplyr::rename("stove" = "stove_type") %>%
    dplyr::rename("id" = "hh_id") %>%
    dplyr::mutate(fuel = ifelse(field_site == "uganda", "Hardwood (lumps)", "Wood (collected)"))
```

```{r}
  saveRDS(field_fp_mce, "../../r_files/field_fp_mce_temp.RDS")
```
