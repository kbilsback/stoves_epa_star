---
title: "field_india_montecarlo"
author: "ricardo_piedrahita"
date: "8/14/2017"
output: html_document
---

```{r library, message=FALSE, warning=FALSE, echo=FALSE}
  library(tidyverse)
  library(knitr)
  library(lubridate)
  library(dplyr)
  library(plyr)
  library(magrittr)
  library(ggplot2)
  library(grid)
  library(gridExtra)
```

```{r global_options, include=FALSE}
  knitr::opts_chunk$set(fig.path='figures/', warning=FALSE, message=FALSE, cache=FALSE)
```

```{r functions}
  source("../r_scripts/functions.R")
  source("../r_scripts/plots.R")
```

# Load data

* PM and CO emissions
* Room level concentrations
* Distributions of ventilation rates
* Time stamps are fixed in the data importing step

```{r load_data}
  field_ecoc_merged <- readRDS("../r_files/field_ecoc_merged.RDS") #Household level ec and oc measurements
  field_emissions <- readRDS("../r_files/field_emissions.RDS") #In-field emissions measurements (ec, oc)
  field_aqe_merged <- readRDS("../r_files/field_aqe_merged.RDS") #In-field emissions level gas phase measurements
  field_aqe_bkgd <- readRDS("../r_files/field_aqe_bkgd.RDS") 
  field_lascarCO <- readRDS("../r_files/field_lascar.RDS")
  field_air_exchange_rates_india <- readRDS("../r_files/field_air_exchange_rates_india.RDS")
```

* metadata

```{r load_meta}
  field_test_times <- readRDS("../r_files/field_test_times.RDS")
  field_samples <- readRDS("../r_files/field_samples.RDS")
  field_temp_meta <- readRDS("../r_files/field_temp_meta.RDS")
  field_notes <- readRDS("../r_files/field_notes.RDS")
  field_meta <- readRDS("../r_files/field_meta.RDS")
```

* C(t) = Gf/(alpha*V) (1-e^(alpha*t)) + Co(e^(-alpha*t)).  Estimate the room level concentration at time t (C(t)), using the simple box model.  Should have room dimensions (V) in the metadata.  And will have room level concentrations (Ct), initial concentrations (Co), and emissions rate G.  So we just have to draw from distribution of air exchange rate (alpha) determined in past work, and from f, also determined in past work.  Compare estimated Ct with actual Ct; use hypothesis test to determine if value came from the given distribution.



# Merge AQE and Lascar data
```{r merge_data}
field_aqe_merged_CO <- dplyr::filter(field_aqe_merged,grepl("^co$",var)) %>%
    dplyr::mutate(datetime_char = as.character(datetime)) #Making a char time variable to allow joining


field_lascarCO_filtered <- 
    dplyr::rowwise(field_lascarCO) %>%  #Keep only the Lascar data from within the start and stop time of an experiment.
    dplyr::mutate(present = any(datetime >= field_meta$datetime_sample_start &  #Flag the time as in or out of range.
                                  datetime <= field_meta$datetime_sample_end)) %>% 
    dplyr::filter(present) %>% #Filter based on the present true/false variable.
    dplyr::mutate(datetime_char = as.character(datetime)) %>% #Making a char time variable to allow joining
    dplyr::left_join(field_aqe_merged_CO,by = "datetime_char")

```

# plot merged data
* Plot AQE and room-level CO for all tests


```{r plot_raw_data,  fig.width=12, fig.height=20}
datalist = list()
 
# for (i in 1:length(unique(field_aqe_merged$hh_id))){

  
  field_timeseries_plot_co(field_aqe_merged_CO, "val")
  field_timeseries_plot(field_aqe_merged_CO, "val")
  
# 
#       
# datalist[[i]] <- temp # add it to your list
# 
#   
#   
# }


```















