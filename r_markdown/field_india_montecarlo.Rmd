---
title: "field_india_montecarlo"
author: "ricardo_piedrahita"
date: "8/14/2017"
output: html_document
---

```{r library, message=FALSE, warning=FALSE, echo=FALSE}
  library(tidyverse)
  library(knitr)
  library(lubridate)
  library(dplyr)
  library(plyr)
  library(magrittr)
  library(ggplot2)
  library(grid)
  library(gridExtra)
```

```{r global_options, include=FALSE}
  knitr::opts_chunk$set(fig.path='figures/', warning=FALSE, message=FALSE, cache=FALSE)
```

```{r functions}
  source("../r_scripts/functions.R")
  source("../r_scripts/plots.R")
```

# Load data

* PM and CO emissions
* Room level concentrations
* Distributions of ventilation rates
* Time stamps are fixed in the data importing step

```{r load_data}
  field_ecoc_merged <- readRDS("../r_files/field_ecoc_merged.RDS") #Household level ec and oc measurements
  field_emissions <- readRDS("../r_files/field_emissions.RDS") #In-field emissions measurements (ec, oc)
  field_aqe_merged <- readRDS("../r_files/field_aqe_merged.RDS") #In-field emissions level gas phase measurements
  field_aqe_bkgd <- readRDS("../r_files/field_aqe_bkgd.RDS") 
  field_lascarCO <- readRDS("../r_files/field_lascar.RDS")
  field_air_exchange_rates_india <- readRDS("../r_files/field_air_exchange_rates_india.RDS")
```

* metadata

```{r load_meta}
  field_test_times <- readRDS("../r_files/field_test_times.RDS")
  field_samples <- readRDS("../r_files/field_samples.RDS")
  field_temp_meta <- readRDS("../r_files/field_temp_meta.RDS")
  field_notes <- readRDS("../r_files/field_notes.RDS")
  field_meta <- readRDS("../r_files/field_meta.RDS")
```

* C(t) = Gf/(alpha*V) (1-e^(alpha*t)) + Co(e^(-alpha*t)).  Estimate the room level concentration at time t (C(t)), using the simple box model.  Should have room dimensions (V) in the metadata.  And will have room level concentrations (Ct), initial concentrations (Co), and emissions rate G.  So we just have to draw from distribution of air exchange rate (alpha) determined in past work, and from f, also determined in past work.  Compare estimated Ct with actual Ct; use hypothesis test to determine if value came from the given distribution.
q = emission rate (mg or g/min)
Î± = first order loss rate (nominal air exchange rate) (min-1)
V = kitchen volume (m3)
t = time (min)
Co = concentration from preceding time unit (mg or ug/m3)
f = fraction of emissions that enters the kitchen environment = 1

* Convert all CO data to mass concentrations(mg/m3 = Xppm*MolarmassCO/24.45Literpermol).  Correct for pressure as well (multiple by actual atm/ideal atm)?  
* Emissions factors were calculated by Rose in a Matlab script.  
Net ppm CO = CO - CObackground
Net mols CO = PV/RT = Net ppm CO*10E-6*Pressure/R/T_stack
Net mass CO = Net mols CO*MWco
CO_EF = Net mass CO [g]*Wood_cc [kg_C/kg]*WM_c*[mols/kg_C]/mols(CO+CO2) = [g CO/kg wood]

# Merge AQE and Lascar data
```{r merge_data}
field_aqe_merged_CO <- dplyr::filter(field_aqe_merged,grepl("^co$",var)) %>%
    dplyr::mutate(datetime_char = as.character(datetime)) #Making a char time variable to allow joining


field_lascarCO_filtered <- 
    dplyr::rowwise(field_lascarCO) %>%  #Keep only the Lascar data from within the start and stop time of an experiment.
    dplyr::mutate(present = any(datetime >= field_meta$datetime_sample_start &  #Flag the time as in or out of range.
                                  datetime <= field_meta$datetime_sample_end)) %>%
    dplyr::filter(present) %>% #Filter based on the present true/false variable.
    dplyr::mutate(datetime_char = as.character(datetime)) %>% #Making a char time variable to allow joining
    dplyr::left_join(field_aqe_merged_CO,by = "datetime_char") %>%
    dplyr::left_join(dplyr::select(field_air_exchange_rates_india, hh_id, Average, Stove_type,Fuel,Meal,Pot),by = "hh_id")



```


# QC

## flags from notes

* apply flags: `bad` preceeds `maybe` preceeds `good`

```{r flags}
  flags <- dplyr::select(field_notes, hh_id, qc) %>%
           dplyr::group_by(hh_id) %>%
           dplyr::arrange(qc) %>%
           dplyr::summarise(qc = first(qc))
```

* merge flags with data

```{r merge_flags}
  # fix warning
  aqe_merged_all <- dplyr::left_join(aqe_merged_all, flags, by = "hh_id") %>%
                    dplyr::mutate(qc = as.factor(ifelse(is.na(qc), "ok", as.character(qc)))) %>%
                    dplyr::mutate(qc = forcats::lvls_expand(qc, c("bad", "maybe", "ok")))
```


# plot merged and QC'd data
* Plot AQE and room-level CO for all tests


```{r plot_raw_data,  fig.width=12, fig.height=20}


field_timeseries_plot_co <- function(df, y_var, y_var2, color_var = "height", x_var = "datetime.x", facet_var = "hh_id", y_units = "units") {
  
  ggplot(df, aes_string(y = y_var, x = x_var, color = color_var)) +
    geom_line() +
    scale_fill_discrete(drop = FALSE) +
    facet_wrap(~df[[facet_var]], ncol = 1, scales = "free") +
    theme_minimal() +
    theme(legend.position = "top") +
    ylab(paste0(y_var, " (", df[[1, y_units]], ")")) #+
        # geom_line(aes_string(y = y_var2, x = x_var,colour = "Stove_type")) 
  
}
  field_timeseries_plot_co(field_lascarCO_filtered, "calibratedCOppm","val")


# }


```















