---
title: "Flue temperature - India"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r library, message=FALSE, warning=FALSE, echo=FALSE}
  library(tidyverse)
  library(knitr)
  library(lubridate)
```

```{r global_options, include=FALSE}
  knitr::opts_chunk$set(fig.path='figures/', warning=FALSE, message=FALSE, cache=TRUE)
```

```{r functions}
  source("../r_scripts/functions.R")
  source("../r_scripts/plots.R")
```

# Load data

* flue temperature

```{r load_data}
  temp <- readRDS("../r_files/field_temp.RDS")
```

* metadata

```{r load_meta}
  test_times <- readRDS("../r_files/field_test_times.RDS")
  samples <- readRDS("../r_files/field_samples.RDS")
  temp_meta <- readRDS("../r_files/field_temp_meta.RDS")
```

# Tidy

* add household id information

```{r add_hh_id}
  temp_merged_all <- dplyr::left_join(temp, dplyr::select(temp_meta %>%
                                                            dplyr::filter(field_site == "india"),
                                                          logger_id, hh_id, field_site),
                                            by = "logger_id") %>%
                     dplyr::select(-logger_id)
```

```{r}
  temp_merged_all <- 
    temp_merged_all %>%
    #dplyr::group_by(datetime, hh_id) %>%
    dplyr::group_by(datetime = cut(datetime, breaks = "1 min"), hh_id) %>%
    dplyr::summarise(temp = mean(temp, na.rm = TRUE)) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(datetime = as.POSIXct(datetime))
```

* fix India times

```{r fix_times}
  temp_merged_all <-
    temp_merged_all %>%
    dplyr::mutate(datetime = as.POSIXct(datetime),
                  datetime = with_tz(datetime, tz = "Asia/Calcutta"),
                  date = as.Date(datetime, tz = "Asia/Calcutta"),
                  time = as.numeric(lubridate::hms(format(datetime, "%H:%M:%S"))))
```

# QC

## merge flags with data

```{r merge_flags}
  # fix warning
  temp_merged_all <- 
    temp_merged_all %>%
    dplyr::mutate(qc = "ok")
```

```{r}
  temp_merged_all <-
    temp_merged_all %>%
    dplyr::filter(!(hh_id == "IN7"),
                  !(hh_id == "IN7" & date == "2016-05-03" & time > 32400),
                  !(hh_id == "IN8" & date == "2016-04-20"),
                  !(hh_id == "IN8" & date == "2016-04-21" & time < 43200),
                  !(hh_id == "IN8" & date == "2016-04-27" & time > 57600),
                  !(hh_id == "IN8" & date == "2016-04-28"),
                  !(hh_id == "IN8" & date == "2016-04-29"),
                  !(hh_id == "IN8" & date == "2016-04-30"),
                  !(hh_id == "IN8" & date == "2016-05-01" & time < 25200),
                  !(hh_id == "IN8" & date == "2016-05-03"),
                  !(hh_id == "IN8" & date == "2016-05-04"),
                  !(hh_id == "IN8" & date == "2016-05-05"),
                  !(hh_id == "IN8" & date == "2016-05-06"),
                  !(hh_id == "IN8" & date == "2016-05-11"),
                  !(hh_id == "IN8" & date == "2016-05-12"),
                  !(hh_id == "IN8" & date == "2016-05-13"),
                  !(hh_id == "IN8" & date == "2016-05-14"),
                  !(hh_id == "IN8" & date == "2016-05-15"),
                  !(hh_id == "IN8" & date == "2016-05-16"),
                  !(hh_id == "IN8" & date == "2016-05-17"),
                  !(hh_id == "IN8" & date == "2016-05-21"),
                  !(hh_id == "IN8" & date == "2016-05-25"),
                  !(hh_id == "IN8" & date == "2016-05-26"),
                  !(hh_id == "IN8" & date == "2016-05-27"),
                  !(hh_id == "IN10"),
                  !(hh_id == "IN11" & date == "2016-04-20" & time < 43200),
                  !(hh_id == "IN11" & date == "2016-05-15"),
                  !(hh_id == "IN11" & date == "2016-05-16"),
                  !(hh_id == "IN11" & date == "2016-05-17"),
                  !(hh_id == "IN11" & date == "2016-05-18"),
                  !(hh_id == "IN11" & date == "2016-05-19"),
                  !(hh_id == "IN11" & date == "2016-05-20"),
                  !(hh_id == "IN12" & date == "2016-04-20" & time < 36900),
                  !(hh_id == "IN12" & date == "2016-05-03" & time > 38640),
                  !(hh_id == "IN12" & date == "2016-05-04"),
                  !(hh_id == "IN12" & date == "2016-05-05"),
                  !(hh_id == "IN12" & date == "2016-05-06"),
                  !(hh_id == "IN12" & date == "2016-05-07"),
                  !(hh_id == "IN12" & date == "2016-05-08"),
                  !(hh_id == "IN12" & date == "2016-05-09"),
                  !(hh_id == "IN12" & date == "2016-05-10"),
                  !(hh_id == "IN12" & date == "2016-05-11"),
                  !(hh_id == "IN12" & date == "2016-05-12"),
                  !(hh_id == "IN12" & date == "2016-05-13"),
                  !(hh_id == "IN12" & date == "2016-05-14"),
                  !(hh_id == "IN12" & date == "2016-05-15"),
                  !(hh_id == "IN12" & date == "2016-05-16"),
                  !(hh_id == "IN12" & date == "2016-05-17"),
                  !(hh_id == "IN12" & date == "2016-05-22"),
                  !(hh_id == "IN12" & date == "2016-05-23"),
                  !(hh_id == "IN12" & date == "2016-05-24"),
                  !(hh_id == "IN12" & date == "2016-05-25"),
                  !(hh_id == "IN12" & date == "2016-05-26"),
                  !(hh_id == "IN12" & date == "2016-05-27"),
                  !(hh_id == "IN17" & date == "2016-04-20" & time < 43200),
                  !(hh_id == "IN17" & date == "2016-05-10"),
                  !(hh_id == "IN17" & date == "2016-05-11"),
                  !(hh_id == "IN17" & date == "2016-05-12"),
                  !(hh_id == "IN17" & date == "2016-05-27" & time > 43200),
                  !(hh_id == "IN18" & date == "2016-04-20"),
                  !(hh_id == "IN18" & date == "2016-04-21" & time < 43200),
                  !(hh_id == "IN18" & date == "2016-05-18"),
                  !(hh_id == "IN18" & date == "2016-05-19"),
                  !(hh_id == "IN18" & date == "2016-05-20"),
                  !(hh_id == "IN18" & date == "2016-05-21"),
                  !(hh_id == "IN18" & date == "2016-05-22"),
                  !(hh_id == "IN18" & date == "2016-05-23"),
                  !(hh_id == "IN18" & date == "2016-05-24"),
                  !(hh_id == "IN18" & date == "2016-05-25"),
                  !(hh_id == "IN18" & date == "2016-05-26"),
                  !(hh_id == "IN18" & date == "2016-05-27"),
                  !(hh_id == "IN19" & date == "2016-04-25"),
                  !(hh_id == "IN19" & date == "2016-04-26"),
                  !(hh_id == "IN19" & date == "2016-04-27"),
                  !(hh_id == "IN19" & date == "2016-04-28"),
                  !(hh_id == "IN42" & date == "2016-05-01"),
                  !(hh_id == "IN42" & date == "2016-05-02"),
                  !(hh_id == "IN42" & date == "2016-05-03"),
                  !(hh_id == "IN42" & date == "2016-05-04"),
                  !(hh_id == "IN42" & date == "2016-05-05"),
                  !(hh_id == "IN42" & date == "2016-05-06"),
                  !(hh_id == "IN42" & date == "2016-05-07"),
                  !(hh_id == "IN42" & date == "2016-05-08"),
                  !(hh_id == "IN42" & date == "2016-05-09"),
                  !(hh_id == "IN42" & date == "2016-05-10"),
                  !(hh_id == "IN42" & date == "2016-05-11"),
                  !(hh_id == "IN42" & date == "2016-05-12"),
                  !(hh_id == "IN42" & date == "2016-05-13"),
                  !(hh_id == "IN42" & date == "2016-05-14"),
                  !(hh_id == "IN42" & date == "2016-05-15"),
                  !(hh_id == "IN42" & date == "2016-05-16"),
                  !(hh_id == "IN42" & date == "2016-05-17"),
                  !(hh_id == "IN42" & date == "2016-05-18"),
                  !(hh_id == "IN42" & date == "2016-05-19"),
                  !(hh_id == "IN42" & date == "2016-05-20"),
                  !(hh_id == "IN42" & date == "2016-05-21"),
                  !(hh_id == "IN42" & date == "2016-05-22"),
                  !(hh_id == "IN42" & date == "2016-05-23"),
                  !(hh_id == "IN42" & date == "2016-05-24"),
                  !(hh_id == "IN42" & date == "2016-05-25"),
                  !(hh_id == "IN42" & date == "2016-05-26"),
                  !(hh_id == "IN42" & date == "2016-05-27"))
```

```{r, eval=FALSE, fig.height=5}
  temp_merged_all %>%
    dplyr::filter(hh_id == "IN42") %>%
    ggplot(aes(x = datetime, y = temp)) +
      geom_line() +
      facet_wrap(~date, scales = "free")
```

## Filter only test

```{r get_times}
  times <- dplyr::filter(test_times, var == "sample_start" | var == "sample_end") %>%
           tidyr::spread(var, value) %>%
           dplyr::rename(start = sample_start, end = sample_end)
```

```{r filter_tests}
  temp_merged <- filter_times(times, temp_merged_all)
```

# Summary plots

## All temperature data

```{r, fig.height=10}
  temp_merged_all %>%
    ggplot(aes(x = datetime, y = temp)) +
      geom_point() +
      facet_wrap(~hh_id, scales = "free")
```

## Temperature data during tests

```{r, fig.height=10}
  temp_merged %>%
    ggplot(aes(x = datetime, y = temp)) +
      geom_line() +
      facet_wrap(~hh_id, scales = "free")
```

```{r}
  temp_merged <-
    temp_merged %>%
    dplyr::filter(hh_id != "IN19")
```

# Calculate the ambient temperature in each household

```{r}
  amb_temp <-
    temp_merged_all %>%
    dplyr::filter(temp < 40) %>%
    dplyr::group_by(hh_id) %>%
    dplyr::summarise(amb_temp = mean(temp, na.rm = TRUE))
```

* subtract ambient temperature
* exclude data that are less than twice the ambient temperature 

```{r}
  temp_merged_all <-
    temp_merged_all %>%
    dplyr::left_join(amb_temp, by = "hh_id") %>%
    dplyr::mutate(frac_ambient = temp / amb_temp) %>%
    dplyr::filter(frac_ambient > 2) %>%
    dplyr::select(-frac_ambient) %>%
    dplyr::mutate(temp = temp - amb_temp) %>%
    dplyr::select(-amb_temp)
```

## Boxplots of temperature during stove use

```{r, fig.height=4}
  temp_merged_all %>%
    ggplot(aes(x = hh_id, y = temp)) +
      geom_boxplot()
```

## Save files

```{r save_data}
  saveRDS(temp_merged_all, file = "../r_files/india_temp_merged_all.RDS")
  saveRDS(temp_merged, file = "../r_files/india_temp_merged.RDS")
```
