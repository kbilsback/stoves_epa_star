---
title: "gravimetric"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r global_options, include=FALSE}
  knitr::opts_chunk$set(fig.path='figures/', warning=FALSE, message=FALSE, cache=TRUE)
```

```{r load_libraries}
  library(tidyverse)
  library(forcats)
```

```{r load_functions}
  #source("../r_scripts/R_tidy.r")
```

# Load data

* gravimetric

```{r load_data}
  grav <- readRDS("../r_files/field_grav.rds")
```

* metadata

```{r load_meta}
  test_times <- readRDS("../r_files/field_test_times.rds")
  samples <- readRDS("../r_files/field_samples.rds")
  notes <- readRDS("../r_files/field_notes.rds")
  flows <- readRDS("../r_files/field_inst_flows.rds")
  filter_meta <- readRDS("../r_files/field_filter_meta.rds")
```

# Organize

## filter grav data

* select only filters from emission tests that were used

```{r filter_grav}
  emissions_grav <- dplyr::filter(grav, grepl("^IN[0-9]",id)) %>%
                    dplyr::filter(!is.na(filter_mass))
```

## filter meta data

* select only data relevant for grav

```{r filter_meta}
  grav_meta <- dplyr::filter(filter_meta, !is.na(teflon_id)) %>%
               dplyr::filter(filter_type != "Dummy") %>%
               dplyr::select(-quartz_id, -cart_type, -hh_id, -notes) %>%
               dplyr::left_join(dplyr::select(test_times, hh_id, date), by = "date") %>%
               dplyr::mutate(filter_type = fct_drop(filter_type))  # drop unused factor lvls
```

# Metadata

* calculate average flow rates and combine with test times

```{r meta}
 meta <- dplyr::filter(flows, inst == "filter_1") %>%  # need to double check which filter no.
         dplyr::select(-notes) %>%  # go off bubble meter measures only
         dplyr::group_by(hh_id) %>%
         dplyr::summarise(avg_flow = mean(val, na.rm = TRUE)) %>%
         dplyr::mutate(filter_type = "Uncontrolled Test") %>%
         dplyr::left_join(dplyr::select(test_times, -date, -field_site), by = "hh_id")
```

# Merge data with meta

```{r meta_merge}
  grav_merged <- dplyr::left_join(emissions_grav, grav_meta, by = c("id" = "teflon_id")) %>%
                 dplyr::left_join(meta, by = c("hh_id", "filter_type"))
```

* pre-average

```{r calc_pre_wgt}
  grav_pre <- dplyr::select(grav_merged, pre_weigh_1, pre_weigh_2, pre_weigh_3, hh_id) %>%
              tidyr::gather("var", "val", pre_weigh_1, pre_weigh_2, pre_weigh_3) %>%
              dplyr::filter(!is.na(val)) %>%
              dplyr::group_by(hh_id) %>%
              dplyr::summarise(wgt_pre = mean(val))
```

* post-average

```{r calc_post_wgt}
  grav_post <- dplyr::select(grav_merged, post_weigh_1, post_weigh_2, post_weigh_3, hh_id) %>%
               tidyr::gather("var", "val", post_weigh_1, post_weigh_2, post_weigh_3) %>%
               dplyr::filter(!is.na(val)) %>%
               dplyr::group_by(hh_id) %>%
               dplyr::summarise(wgt_post = mean(val))
```

* merge averages

```{r merge_calcs}
  grav_merged <- dplyr::left_join(grav_merged, grav_pre, by = "hh_id") %>%
                 dplyr::left_join(grav_post, by = "hh_id")
```

* mass added

```{r calc_delta_wgt}
  grav_merged <- dplyr::mutate(grav_merged, wgt_delta = wgt_post - wgt_pre)
```

* change in calibration weight

```{r add_cal_wgt}
  grav_merged <- dplyr::mutate(grav_merged, wgt_cal_delta = post_cal_weight - pre_cal_weight)
```

* add pollutant variable `pol`

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  grav_merged <- dplyr::mutate(grav_merged,
                               pol = "grav")
```


* seperate blanks and samples

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  blanks <-   dplyr::left_join(emissions_grav, grav_meta, by = c("id" = "teflon_id")) %>%
              dplyr::filter(filter_type == "Blank")
```

# QC

* extract notes for gravimetric data

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  notes <- dplyr::filter(notes, grepl("grav|all", notes$inst) == TRUE)
```

* mark `bad` tests

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  notes$qc[33] <- "bad"
  notes$qc[34] <- "bad"
```

* apply flags: `bad` preceeds `maybe` preceeds `good`

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  flags <- dplyr::select(notes, id, qc) %>%
           dplyr::group_by(id) %>%
           dplyr::arrange(qc) %>%
           dplyr::summarise(qc = first(qc))
```

* merge

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  grav_merged <- dplyr::left_join(grav_merged, flags, by = "id") %>%
                 dplyr::mutate(id = as.factor(id)) %>%
                 dplyr::mutate(qc = as.factor(ifelse(is.na(qc), "ok", as.character(qc))))
```

Additional bad tests

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  grav_merged$qc[grav_merged$id == "28A"] <- "bad"
  grav_merged$qc[grav_merged$id == "28B"] <- "bad"
  grav_merged$qc[grav_merged$id == "29A"] <- "bad"
```

# LOD/LOQ

* remove backgrounds and bad data then calculate the limit of detection and quantification

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  signal <- dplyr::filter(grav_merged, type == "test", qc != "bad") %>%
            dplyr::summarise(lod = sd(wgt_blank_delta) * 3 - mean(wgt_blank_delta),
                             loq = sd(wgt_blank_delta) * 10 - mean(wgt_blank_delta))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  lod_var <- signal$lod[1]
  loq_var <- signal$loq[1]
```

The LOD is `r lod_var`, the LOQ is `r loq_var`.

* flag the measurements

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  grav_merged <- dplyr::mutate(grav_merged,
                               lod = ifelse(wgt_delta >= lod_var, "above", "below"),
                               loq = ifelse(wgt_delta >= loq_var, "above", "below"))
```

# Background analysis

* extract background data
* remove missing data
* calculate average concentration emitted ( and other stats)

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  bg <- dplyr::filter(grav_merged, type == "bg", qc == "ok") %>%
        dplyr::select(id, flow,
                         start, end,
                         wgt_delta) %>%
        na.omit() %>%
        dplyr::mutate(dur = (end - start) / 60,
                      conc = wgt_delta * 1000 / (flow * dur)) %>%
        dplyr::summarise(conc_bg = mean(conc),
                         sd = sd(conc),
                         min = min(conc),
                         max = max(conc),
                         n = n()) %>%
        dplyr::mutate(type = factor("test", levels_type))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  knitr::kable(bg, "markdown", digits = 2)
```

* add background to main dataframe

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  grav_merged <- dplyr::left_join(grav_merged,
                                  dplyr::select(bg, type, conc_bg),
                                                by = "type")
```

# Summary

Gravimetric data was collected during `r length(unique(grav_merged$id))` experiments between `r min(grav_merged$date, na.rm = TRUE)` and `r max(grav_merged$date, na.rm = TRUE)`. There is no $Gravimetric$ data for tests: `r setdiff(as.character(samples$id), as.character(grav_merged$id))`.

Gravimetric data is expected to be missing for: 17A only. Filter ruptured so could not be post-weighed. 

# Save merged file

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  save(grav_merged, file = "../r_files/grav_merged.Rda")
```

# Plots

## weights

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=12, fig.height=8}
  ggplot(dplyr::filter(grav_merged, grepl("^[0-9][A-Z]", id)==TRUE),
         aes(id, wgt_delta, color= qc)) +
  geom_point() +
  theme_minimal()
  
  ggplot(dplyr::filter(grav_merged, grepl("^[1][0-9][A-Z]", id)==TRUE),
         aes(id, wgt_delta, color= qc)) +
  geom_point() +
  theme_minimal()
  
  ggplot(dplyr::filter(grav_merged, grepl("^[2-3][0-9][A-Z]", id)==TRUE),
         aes(id, wgt_delta, color= qc)) +
  geom_point() +
  theme_minimal()
  
  ggplot(dplyr::filter(grav_merged, grepl("^[G]", id)==TRUE),
         aes(id, wgt_delta, color= qc)) +
  geom_point() +
  theme_minimal()
```

## calibration

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=12, fig.height=8}
  ggplot(grav_merged, aes(id, wgt_cal_delta)) +
  geom_point() +
  theme_minimal() +
  ylab("Cal weight delta (mg)") +
  theme(text = element_text(size=8), axis.text.x = element_text(angle=-45, hjust=1))
```

## blanks

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=12, fig.height=8}
  ggplot(grav_merged, aes(id, wgt_blank_delta)) +
  geom_point() +
  theme_minimal() +
  ylab("Blanks weight delta (mg)") +
  theme(text = element_text(size=8), axis.text.x = element_text(angle=-45, hjust=1)) 
```
